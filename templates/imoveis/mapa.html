{% extends "base.html" %}

{% block title %}Mapa de Imóveis{% endblock %}
{% block page_title %}Mapa de Imóveis{% endblock %}

{% block content %}
<div id="map" style="height: 600px; width: 100%;"></div>
<div id="photos-modal" class="modal">
    <div class="modal-content photo-modal-content">
        <span class="close-button" onclick="closePhotosModal()">&times;</span>
        <h2 class="text-lg font-semibold mb-4">Mídias do Imóvel</h2>
        <div id="main-media-wrapper" class="flex justify-center mb-4 hidden">
            <img id="main-photo" class="photo-main rounded shadow hidden" src="" alt="Foto principal">
            <div id="main-video-wrapper" class="w-full hidden">
                <div class="relative w-full" style="aspect-ratio: 16 / 9;">
                    <iframe id="main-video" class="w-full h-full rounded shadow" src="" title="Vídeo do Imóvel" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                </div>
            </div>
        </div>
        <div id="thumbs-container" class="flex justify-center gap-2 flex-wrap"></div>
        <div id="documents-container" class="mt-6 border-t pt-4 hidden">
            <h3 class="text-md font-semibold mb-2">Documentos</h3>
            <ul id="documents-list" class="list-disc list-inside space-y-1 text-sm text-gray-700"></ul>
        </div>
    </div>
</div>
<div class="mt-4 flex space-x-8">
    <div class="flex items-center">
        <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png" class="w-4 h-7" alt="Marcador azul">
        <span class="ml-2">Contrato de aluguel ativo</span>
    </div>
    <div class="flex items-center">
        <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png" class="w-4 h-7" alt="Marcador vermelho">
        <span class="ml-2">Sem contrato de aluguel ativo</span>
    </div>
</div>
<div class="mt-4 flex flex-wrap gap-4">
    <div class="bg-white rounded shadow px-4 py-2">
        <span class="font-semibold">Total de Imóveis:</span> {{ total_imoveis }}
    </div>
    <div class="bg-white rounded shadow px-4 py-2">
        <span class="font-semibold">Total de Imóveis Alugados:</span> {{ total_alugados }}
    </div>
    <div class="bg-white rounded shadow px-4 py-2">
        <span class="font-semibold">Total de Imóveis Disponíveis:</span> {{ total_disponiveis }}
    </div>
    <div class="bg-white rounded shadow px-4 py-2">
        <span class="font-semibold">% de Vacância:</span> {{ "%.2f"|format(vacancia_percent) }}%
    </div>
</div>
<div class="flex justify-end mt-6">
    <a href="{{ url_for('imoveis_list') }}" class="btn btn-secondary">Voltar</a>
</div>
{% endblock %}

{% block scripts %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const imoveis = {{ imoveis | tojson | safe }};

            const map = L.map('map').setView([-15.7801, -47.9292], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const blueIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            const redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            imoveis.forEach(imovel => {
                if (imovel.latitude && imovel.longitude) {
                    const icon = imovel.contrato_ativo ? blueIcon : redIcon;
                    const marker = L.marker([imovel.latitude, imovel.longitude], { icon }).addTo(map);
                    marker.bindPopup(
                        `<b>ID:</b> ${imovel.id}<br>` +
                        `<b>Matrícula:</b> ${imovel.matricula || 'N/A'}<br>` +
                        `<button type="button" class="btn-primary mt-2 view-photos-btn" data-id="${imovel.id}">Ver Fotos</button>`
                    );
                    const tooltipContent =
                        `<b>${imovel.endereco}, ${imovel.bairro}</b><br>` +
                        `IPTU: ${imovel.inscricao_iptu || 'N/A'}<br>` +
                        `Cliente: ${imovel.cliente_nome || 'Sem contrato ativo'}`;
                    marker.bindTooltip(tooltipContent);
                    marker.on('mouseover', function () { this.openTooltip(); });
                    marker.on('mouseout', function () { this.closeTooltip(); });
                }
            });
            
            map.on('popupopen', function(e) {
                const btn = e.popup.getElement().querySelector('.view-photos-btn');
                if (btn) {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-id');
                        openPhotosModal(id);
                    });
                }
            });

            function openPhotosModal(id) {
                fetch(`/imoveis/fotos/${id}`)
                    .then(r => r.json())
                    .then(data => {
                        const photos = Array.isArray(data.photos) ? data.photos : [];
                        const video = data.video || null;
                        const documents = Array.isArray(data.documents) ? data.documents : [];
                        const mainWrapper = document.getElementById('main-media-wrapper');
                        const mainPhoto = document.getElementById('main-photo');
                        const mainVideoWrapper = document.getElementById('main-video-wrapper');
                        const mainVideo = document.getElementById('main-video');
                        const videoFrame = document.getElementById('video-frame');
                        const documentsContainer = document.getElementById('documents-container');
                        const documentsList = document.getElementById('documents-list');
                        const thumbs = document.getElementById('thumbs-container');

                        thumbs.innerHTML = '';
                        documentsList.innerHTML = '';

                        let hasMedia = false;

                        function showPhoto(url) {
                            if (!url) {
                                return;
                            }
                            hasMedia = true;
                            mainWrapper.classList.remove('hidden');
                            mainVideoWrapper.classList.add('hidden');
                            mainVideo.src = '';
                            mainPhoto.src = url;
                            mainPhoto.classList.remove('hidden');
                        }

                        function showVideo(embedUrl) {
                            if (!embedUrl) {
                                return;
                            }
                            hasMedia = true;
                            mainWrapper.classList.remove('hidden');
                            mainPhoto.classList.add('hidden');
                            mainPhoto.src = '';
                            mainVideoWrapper.classList.remove('hidden');
                            mainVideo.src = embedUrl;
                        }

                        photos.forEach((url, index) => {
                            if (!url) {
                                return;
                            }
                            if (index === 0) {
                                showPhoto(url);
                            }
                            const img = document.createElement('img');
                            img.src = url;
                            img.className = 'photo-thumb object-cover rounded cursor-pointer';
                            img.addEventListener('click', () => {
                                showPhoto(url);
                            });
                            thumbs.appendChild(img);
                        });

                        const videoInfo = extractYouTubeInfo(video);
                        if (videoInfo) {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'media-thumb cursor-pointer';

                            const img = document.createElement('img');
                            img.src = videoInfo.thumbUrl;
                            img.alt = 'Miniatura do vídeo';
                            img.className = 'photo-thumb object-cover rounded';
                            wrapper.appendChild(img);

                            const overlay = document.createElement('div');
                            overlay.className = 'video-thumb-overlay';
                            overlay.innerHTML = '<i class="fas fa-play"></i>';
                            wrapper.appendChild(overlay);

                            wrapper.addEventListener('click', () => {
                                showVideo(videoInfo.embedUrl);
                            });

                            thumbs.appendChild(wrapper);

                            if (!hasMedia) {
                                showVideo(videoInfo.embedUrl);
                            }
                        }

                        if (!hasMedia) {
                            mainWrapper.classList.add('hidden');
                            mainPhoto.classList.add('hidden');
                            mainVideoWrapper.classList.add('hidden');
                            mainVideo.src = '';
                            thumbs.innerHTML = '<p class="text-center w-full">Sem mídias cadastradas.</p>';
                        }

                        if (documents.length > 0) {
                            documents.forEach(doc => {
                                if (!doc || !doc.url) {
                                    return;
                                }
                                const li = document.createElement('li');
                                const link = document.createElement('a');
                                link.href = doc.url;
                                link.target = '_blank';
                                link.rel = 'noopener';
                                link.className = 'text-blue-600 hover:underline break-all';
                                link.textContent = doc.name || doc.url;
                                li.appendChild(link);
                                documentsList.appendChild(li);
                            });
                            documentsContainer.classList.remove('hidden');
                        } else {
                            documentsContainer.classList.add('hidden');
                        }

                        document.getElementById('photos-modal').style.display = 'flex';
                    });
            }

            window.closePhotosModal = function() {
                document.getElementById('photos-modal').style.display = 'none';
                const mainVideo = document.getElementById('main-video');
                if (mainVideo) {
                    mainVideo.src = '';
                }
            }

            function extractYouTubeInfo(rawUrl){
                if(!rawUrl){
                    return null;
                }
                try {
                    const url = new URL(rawUrl);
                    const host = url.hostname.replace('www.', '');
                    if (host === 'youtu.be') {
                        const videoId = url.pathname.replace('/', '');
                        return buildInfo(videoId);
                    }
                    if (host.endsWith('youtube.com')) {
                        if (url.searchParams.get('v')) {
                            return buildInfo(url.searchParams.get('v'));
                        }
                        if (url.pathname.startsWith('/embed/')) {
                            const parts = url.pathname.split('/').filter(Boolean);
                            return buildInfo(parts[1] || parts[0], rawUrl);
                        }
                        if (url.pathname.startsWith('/shorts/')) {
                            const parts = url.pathname.split('/').filter(Boolean);
                            if (parts.length > 1) {
                                return buildInfo(parts[1]);
                            }
                        }
                    }
                } catch (e) {
                    return null;
                }
                return null;

                function buildInfo(videoId, embed){
                    const cleanId = (videoId || '').split('?')[0].split('&')[0];
                    if(!cleanId){
                        return null;
                    }
                    const embedUrl = embed || `https://www.youtube.com/embed/${cleanId}`;
                    return {
                        embedUrl,
                        thumbUrl: `https://img.youtube.com/vi/${cleanId}/hqdefault.jpg`
                    };
                }
            }
        });
    </script>
{% endblock %}
