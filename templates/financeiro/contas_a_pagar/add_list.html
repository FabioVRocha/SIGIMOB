<!-- templates/financeiro/contas_a_pagar/add_edit.html -->
{% extends "base.html" %}

{% block title %}
    {% if conta.id %}Editar Conta a Pagar{% else %}Nova Conta a Pagar{% endif %}
{% endblock %}

{% block page_title %}
    {% if conta.id %}Editar Conta a Pagar{% else %}Nova Conta a Pagar{% endif %}
{% endblock %}

{% block content %}
<div class="bg-white p-6 rounded-lg shadow-xl">
    <form action="{% if conta.id %}{{ url_for('contas_a_pagar_edit', id=conta.id) }}{% else %}{{ url_for('contas_a_pagar_add') }}{% endif %}" method="POST">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
            <div class="form-group">
                <label for="despesa_id" class="form-label">Despesa:</label>
                <select id="despesa_id" name="despesa_id" class="form-select" required>
                    <option value="">Selecione...</option>
                    {% for des in despesas %}
                    <option value="{{ des.id }}" {% if conta.despesa_id == des.id %}selected{% endif %}>{{ des.descricao }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="fornecedor_id" class="form-label">Fornecedor:</label>
                <select id="fornecedor_id" name="fornecedor_id" class="form-select" required>
                    <option value="">Selecione...</option>
                    {% for forn in fornecedores %}
                    <option value="{{ forn.id }}" {% if conta.fornecedor_id == forn.id %}selected{% endif %}>{{ forn.razao_social_nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="titulo" class="form-label">Título:</label>
                <input type="text" id="titulo" name="titulo" class="form-input" value="{{ conta.titulo | default('') }}" required>
            </div>
            <div class="form-group">
                <label for="data_vencimento" class="form-label">Data Vencimento:</label>
                <input type="date" id="data_vencimento" name="data_vencimento" class="form-input" value="{{ conta.data_vencimento | default('') }}" required>
            </div>
            <div class="form-group">
                <label for="competencia" class="form-label">Competência:</label>
                <input type="text" id="competencia" name="competencia" class="form-input" placeholder="MM/AAAA" pattern="\d{2}/\d{4}" value="{{ conta.competencia.strftime('%m/%Y') if conta.competencia and not (conta.competencia is string) else (conta.competencia or '') }}">
            </div>
            <div class="form-group">
                <label for="valor_previsto" class="form-label">Valor Previsto:</label>
                <input type="text" inputmode="decimal" id="valor_previsto" name="valor_previsto" class="form-input currency-input" value="{{ conta.valor_previsto and (conta.valor_previsto | currency) or '' }}" required>
            </div>
            <div class="form-group">
                <label for="data_pagamento" class="form-label">Data Pagamento:</label>
                <input type="date" id="data_pagamento" name="data_pagamento" class="form-input" value="{{ conta.data_pagamento | default('') }}">
            </div>
            <div class="form-group">
                <label for="valor_pago" class="form-label">Valor Pago:</label>
                <input type="text" inputmode="decimal" id="valor_pago" name="valor_pago" class="form-input currency-input" value="{{ conta.valor_pago and (conta.valor_pago | currency) or '' }}">
            </div>
            <div class="form-group">
                <label for="valor_desconto" class="form-label">Desconto:</label>
                <input type="text" inputmode="decimal" id="valor_desconto" name="valor_desconto" class="form-input currency-input" value="{{ (conta.valor_desconto | default(0)) | currency }}">
            </div>
            <div class="form-group">
                <label for="valor_multa" class="form-label">Multa:</label>
                <input type="text" inputmode="decimal" id="valor_multa" name="valor_multa" class="form-input currency-input" value="{{ (conta.valor_multa | default(0)) | currency }}">
            </div>
            <div class="form-group">
                <label for="valor_juros" class="form-label">Juros:</label>
                <input type="text" inputmode="decimal" id="valor_juros" name="valor_juros" class="form-input currency-input" value="{{ (conta.valor_juros | default(0)) | currency }}">
            </div>
            <div class="form-group">
                <label for="imovel_display" class="form-label">Imóvel:</label>
                <div class="flex">
                    {% set ns = namespace(text='') %}
                    {% if conta.imovel_id %}
                        {% for im in imoveis %}
                            {% if im.id == conta.imovel_id %}
                                {% set ns.text = im.endereco ~ ', ' ~ im.bairro %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    <input type="text" id="imovel_display" class="form-input flex-grow" readonly value="{{ ns.text }}">
                    <button type="button" class="btn-secondary ml-2" onclick="openImovelModal()">Selecionar</button>
                    <button type="button" class="btn-secondary ml-2" onclick="clearImovel()">Limpar</button>
                </div>
                <input type="hidden" id="imovel_id" name="imovel_id" value="{{ conta.imovel_id | default('', true) }}">
            </div>
            <div class="form-group">
                <label class="form-label">Status:</label>
                <p class="form-input bg-gray-100" readonly>{{ conta.get('status_conta', 'Aberta') }}</p>
            </div>
            <div class="form-group">
                <label for="origem_id" class="form-label">Origem:</label>
                <select id="origem_id" name="origem_id" class="form-select">
                    <option value="">Selecione...</option>
                    {% for orig in origens %}
                    <option value="{{ orig.id }}" {% if conta.origem_id == orig.id %}selected{% endif %}>{{ orig.descricao }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group md:col-span-2 lg:col-span-3">
                <label for="observacao" class="form-label">Observação:</label>
                <textarea id="observacao" name="observacao" class="form-input">{{ conta.observacao | default('') }}</textarea>
            </div>
        </div>
        <div class="flex justify-end space-x-4">
            <a href="{{ url_for('contas_a_pagar_list') }}" class="btn-secondary">Voltar</a>
            <button type="submit" class="btn-primary">
                {% if conta.id %}Atualizar{% else %}Cadastrar{% endif %}
            </button>
        </div>
    </form>
</div>

<div id="imovel-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeImovelModal()">&times;</span>
        <h2 class="text-lg font-semibold mb-4">Selecionar Imóvel</h2>
        <div class="overflow-y-auto" style="max-height:400px;">
            <table class="min-w-full bg-white rounded-lg overflow-hidden">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="py-2 px-3 text-left text-sm font-semibold text-gray-700">ID</th>
                        <th class="py-2 px-3 text-left text-sm font-semibold text-gray-700">Endereço</th>
                        <th class="py-2 px-3"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for imovel in imoveis %}
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="py-2 px-3 text-sm text-gray-700">{{ imovel.id }}</td>
                        <td class="py-2 px-3 text-sm text-gray-700">{{ imovel.endereco }}, {{ imovel.bairro }}</td>
                        <td class="py-2 px-3 text-right">
                            <button type="button" class="btn-primary select-imovel-btn" data-id="{{ imovel.id }}" data-text="{{ imovel.endereco }}, {{ imovel.bairro }}">Escolher</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function openImovelModal(){
    document.getElementById('imovel-modal').style.display = 'flex';
}
function closeImovelModal(){
    document.getElementById('imovel-modal').style.display = 'none';
}
function selectImovel(id, texto){
    document.getElementById('imovel_id').value = id;
    document.getElementById('imovel_display').value = texto;
    closeImovelModal();
}
function clearImovel(){
    document.getElementById('imovel_id').value = '';
    document.getElementById('imovel_display').value = '';
}

document.addEventListener('DOMContentLoaded', () => {
    // Máscara BRL para campos monetários
    const currencyFormatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    function formatCurrencyInput(el){
        const digits = (el.value || '').toString().replace(/\D/g,'');
        if(!digits){ el.value = ''; return; }
        const value = parseInt(digits,10)/100;
        el.value = currencyFormatter.format(value);
    }
    document.querySelectorAll('.currency-input').forEach(el => {
        // Formata valor inicial, se houver
        if(el.value && !/^\s*$/.test(el.value)){
            formatCurrencyInput(el);
        }
        el.addEventListener('input', () => formatCurrencyInput(el));
        el.addEventListener('blur', () => formatCurrencyInput(el));
    });

    const input = document.getElementById('competencia');
    if (input) {
        input.addEventListener('input', (e) => {
            let v = e.target.value.replace(/[^0-9]/g, '').slice(0,6);
            if (v.length >= 2) {
                e.target.value = v.slice(0,2) + '/' + v.slice(2);
            } else {
                e.target.value = v;
            }
        });
    }
    document.querySelectorAll('.select-imovel-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            selectImovel(btn.dataset.id, btn.dataset.text);
        });
    });
});
</script>
{% endblock %}
