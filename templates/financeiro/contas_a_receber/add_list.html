<!-- templates/financeiro/contas_a_receber/add_edit.html -->
{% extends "base.html" %}

{% block title %}
    {% if conta.id %}Editar Conta a Receber{% else %}Nova Conta a Receber{% endif %}
{% endblock %}

{% block page_title %}
    {% if conta.id %}Editar Conta a Receber{% else %}Nova Conta a Receber{% endif %}
{% endblock %}

{% block content %}
<div class="bg-white p-6 rounded-lg shadow-xl">
    <form action="{% if conta.id %}{{ url_for('contas_a_receber_edit', id=conta.id) }}{% else %}{{ url_for('contas_a_receber_add') }}{% endif %}" method="POST">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
            <div class="form-group">
                <label for="contrato_id" class="form-label">Contrato (opcional):</label>
                <input type="number" id="contrato_id" name="contrato_id" class="form-input" value="{{ conta.contrato_id | default('') }}">
            </div>
            <div class="form-group">
                <label for="receita_id" class="form-label">Receita:</label>
                <select id="receita_id" name="receita_id" class="form-select" required>
                    <option value="">Selecione...</option>
                    {% for rec in receitas %}
                    <option value="{{ rec.id }}" {% if conta.receita_id == rec.id %}selected{% endif %}>{{ rec.descricao }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="cliente_id" class="form-label">Cliente:</label>
                <div class="flex gap-2">
                    <select id="cliente_id" name="cliente_id" class="form-select flex-1" required>
                        <option value="">Selecione...</option>
                        {% for cli in clientes %}
                        <option value="{{ cli.id }}" {% if conta.cliente_id == cli.id %}selected{% endif %}>{{ cli.razao_social_nome }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" id="openClienteModal" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg border border-gray-300 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Buscar cliente" aria-label="Buscar cliente">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label for="titulo" class="form-label">Título:</label>
                <input type="text" id="titulo" name="titulo" class="form-input" value="{{ conta.titulo | default('') }}">
            </div>
            <div class="form-group">
                <label for="data_vencimento" class="form-label">Data Vencimento:</label>
                <input type="date" id="data_vencimento" name="data_vencimento" class="form-input" value="{{ conta.data_vencimento | default('') }}" required>
            </div>
            <div class="form-group">
                <label for="valor_previsto" class="form-label">Valor Previsto:</label>
                <input type="text" inputmode="decimal" id="valor_previsto" name="valor_previsto" class="form-input currency-input" value="{{ conta.valor_previsto and (conta.valor_previsto | currency) or '' }}" required>
            </div>
            <div class="form-group">
                <label for="data_pagamento" class="form-label">Data Pagamento:</label>
                <input type="date" id="data_pagamento" name="data_pagamento" class="form-input" value="{{ conta.data_pagamento | default('') }}">
            </div>
            <div class="form-group">
                <label for="valor_pago" class="form-label">Valor Pago:</label>
                <input type="text" inputmode="decimal" id="valor_pago" name="valor_pago" class="form-input currency-input" value="{{ conta.valor_pago and (conta.valor_pago | currency) or '' }}">
            </div>
            <div class="form-group">
                <label for="valor_desconto" class="form-label">Desconto:</label>
                <input type="text" inputmode="decimal" id="valor_desconto" name="valor_desconto" class="form-input currency-input" value="{{ (conta.valor_desconto | default(0)) | currency }}">
            </div>
            <div class="form-group">
                <label for="valor_multa" class="form-label">Multa:</label>
                <input type="text" inputmode="decimal" id="valor_multa" name="valor_multa" class="form-input currency-input" value="{{ (conta.valor_multa | default(0)) | currency }}">
            </div>
            <div class="form-group">
                <label for="valor_juros" class="form-label">Juros:</label>
                <input type="text" inputmode="decimal" id="valor_juros" name="valor_juros" class="form-input currency-input" value="{{ (conta.valor_juros | default(0)) | currency }}">
            </div>
            <div class="form-group">
                <label class="form-label">Status:</label>
                <p class="form-input bg-gray-100" readonly>{{ conta.get('status_conta', 'Aberta') }}</p>
            </div>
            <div class="form-group">
                <label for="origem_id" class="form-label">Origem:</label>
                <select id="origem_id" name="origem_id" class="form-select">
                    <option value="">Selecione...</option>
                    {% for orig in origens %}
                    <option value="{{ orig.id }}" {% if conta.origem_id == orig.id %}selected{% endif %}>{{ orig.descricao }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group md:col-span-2 lg:col-span-3">
                <label for="observacao" class="form-label">Observação:</label>
                <textarea id="observacao" name="observacao" class="form-input">{{ conta.observacao | default('') }}</textarea>
            </div>
        </div>
        <div class="flex justify-end space-x-4">
            <a href="{{ url_for('contas_a_receber_list') }}" class="btn-secondary">Voltar</a>
            <button type="submit" class="btn-primary">
                {% if conta.id %}Atualizar{% else %}Cadastrar{% endif %}
            </button>
        </div>
    </form>
</div>

<div id="clienteModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white w-full max-w-3xl mx-4 rounded-xl shadow-2xl p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-gray-800">Selecionar Cliente</h2>
            <button type="button" class="text-gray-500 hover:text-gray-700 text-2xl leading-none" data-close-cliente>
                <span class="sr-only">Fechar</span>
                &times;
            </button>
        </div>
        <div class="mb-4">
            <label for="clienteSearchInput" class="block text-sm font-medium text-gray-700 mb-1">Buscar cliente</label>
            <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400"><i class="fas fa-search"></i></span>
                <input type="text" id="clienteSearchInput" class="form-input w-full pl-10" placeholder="Digite nome ou documento do cliente">
            </div>
        </div>
        <div class="max-h-96 overflow-y-auto border border-gray-200 rounded-lg">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Documento</th>
                        <th scope="col" class="px-4 py-3"></th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for cli in clientes %}
                    <tr data-cliente-item data-search="{{ (cli.razao_social_nome ~ ' ' ~ (cli.cpf_cnpj | default(''))) | lower }}">
                        <td class="px-4 py-3">
                            <div class="text-sm font-medium text-gray-900">{{ cli.razao_social_nome }}</div>
                            {% if cli.email %}
                            <div class="text-xs text-gray-500">{{ cli.email }}</div>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">{{ cli.cpf_cnpj | default('Não informado') }}</td>
                        <td class="px-4 py-3 text-right">
                            <button type="button" class="px-3 py-1.5 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" data-select-cliente data-id="{{ cli.id }}">
                                Selecionar
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" class="px-4 py-6 text-center text-gray-500 text-sm">
                            Nenhum cliente cadastrado até o momento.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const currencyFormatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
  function formatCurrencyInput(el){
      const digits = (el.value || '').toString().replace(/\D/g,'');
      if(!digits){ el.value=''; return; }
      const value = parseInt(digits,10)/100;
      el.value = currencyFormatter.format(value);
  }
  document.querySelectorAll('.currency-input').forEach(el => {
      if(el.value && !/^\s*$/.test(el.value)){
          formatCurrencyInput(el);
      }
      el.addEventListener('input', () => formatCurrencyInput(el));
      el.addEventListener('blur', () => formatCurrencyInput(el));
  });

  const clienteModal = document.getElementById('clienteModal');
  if(clienteModal){
      const openModalBtn = document.getElementById('openClienteModal');
      const clienteSelect = document.getElementById('cliente_id');
      const searchInput = document.getElementById('clienteSearchInput');
      const clienteRows = clienteModal.querySelectorAll('[data-cliente-item]');
      const selectButtons = clienteModal.querySelectorAll('[data-select-cliente]');
      const closeButtons = clienteModal.querySelectorAll('[data-close-cliente]');

      const filterClientes = (term = '') => {
          const normalized = term.trim().toLowerCase();
          clienteRows.forEach(row => {
              const rowContent = row.dataset.search || '';
              const shouldHide = normalized && !rowContent.includes(normalized);
              row.classList.toggle('hidden', shouldHide);
          });
      };

      const closeModal = () => {
          clienteModal.classList.add('hidden');
          if(searchInput){
              searchInput.value = '';
              filterClientes('');
          }
      };

      const openModal = () => {
          clienteModal.classList.remove('hidden');
          if(searchInput){
              searchInput.value = '';
              filterClientes('');
              setTimeout(() => searchInput.focus(), 100);
          }
      };

      openModalBtn?.addEventListener('click', openModal);
      closeButtons.forEach(btn => btn.addEventListener('click', closeModal));
      clienteModal.addEventListener('click', (event) => {
          if(event.target === clienteModal){
              closeModal();
          }
      });
      searchInput?.addEventListener('input', (event) => filterClientes(event.target.value));
      selectButtons.forEach(btn => {
          btn.addEventListener('click', () => {
              const clienteId = btn.getAttribute('data-id');
              if(clienteSelect && clienteId){
                  clienteSelect.value = clienteId;
                  clienteSelect.dispatchEvent(new Event('change', { bubbles: true }));
              }
              closeModal();
          });
      });
  }
});
</script>
{% endblock %}
