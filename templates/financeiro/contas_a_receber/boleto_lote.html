{% extends "base.html" %}

{% block title %}Boletos em Lote{% endblock %}

{% block page_title %}Boletos em Lote{% endblock %}

{% block content %}
<div class="bg-white p-6 rounded-lg shadow-xl">
    <div class="flex flex-col lg:flex-row lg:items-start justify-between gap-6">
        <div>
            <div class="flex items-center gap-3">
                <i class="fas fa-layer-group text-2xl text-indigo-500"></i>
                <h2 class="text-2xl font-semibold text-dark-blue">Visualiza√ßao dos boletos</h2>
            </div>
            <dl class="mt-4 space-y-1 text-sm text-gray-600">
                <div class="flex flex-wrap gap-2">
                    <dt class="font-semibold text-gray-700">Titulos selecionados:</dt>
                    <dd>{{ titulos|length }}</dd>
                </div>
                <div class="flex flex-wrap gap-2">
                    <dt class="font-semibold text-gray-700">Clientes:</dt>
                    <dd>{{ cliente_labels|join(', ') if cliente_labels else 'Nao informado' }}</dd>
                </div>
                <div class="flex flex-wrap gap-2">
                    <dt class="font-semibold text-gray-700">Contratos:</dt>
                    <dd>{{ contrato_labels|join(', ') if contrato_labels else 'Nao informado' }}</dd>
                </div>
            </dl>
            <div id="feedback" class="mt-4 text-sm font-medium text-gray-700"></div>
        </div>
        <div class="flex flex-wrap items-center gap-2">
            <button class="btn-secondary flex items-center gap-2" id="btnPrev" type="button">
                <i class="fas fa-arrow-left"></i>
                <span>Anterior</span>
            </button>
            <span id="pageIndicator" class="text-sm font-semibold text-dark-blue">
                {{ 1 if titulos|length else 0 }} / {{ titulos|length }}
            </span>
            <button class="btn-secondary flex items-center gap-2" id="btnNext" type="button">
                <span>Proximo</span>
                <i class="fas fa-arrow-right"></i>
            </button>
            <button class="btn-primary flex items-center gap-2" id="btnGenerate" type="button">
                <i class="fas fa-file-download"></i>
                <span>Gerar PDFs e Remessa</span>
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mt-6">
        <aside class="lg:col-span-1 bg-slate-50 border border-gray-200 rounded-lg">
            <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-dark-blue">Titulos</h3>
                <span class="text-xs font-medium text-gray-500">{{ titulos|length }} itens</span>
            </div>
            <div id="titulosList" class="max-h-96 overflow-y-auto p-3 space-y-3">
                {% for titulo in titulos_data %}
                <div class="titulo-item flex flex-col gap-1 p-3 rounded-lg border border-gray-200 bg-white hover:border-indigo-300 hover:shadow-sm transition cursor-pointer" data-index="{{ loop.index0 }}">
                    <div class="text-sm font-semibold text-gray-800">#{{ titulo.id }} - {{ titulo.label }}</div>
                    {% if titulo.cliente_nome %}
                    <div class="text-xs text-gray-500">{{ titulo.cliente_nome }}</div>
                    {% endif %}
                    {% if titulo.contrato_label %}
                    <div class="text-xs text-gray-500">Contrato: {{ titulo.contrato_label }}</div>
                    {% endif %}
                    {% if titulo.data_vencimento %}
                    <div class="text-xs text-gray-500">Vencimento: {{ titulo.data_vencimento }}</div>
                    {% endif %}
                    <div class="text-xs text-gray-500">Valor: {{ 'R$ %.2f' % titulo.valor_previsto }}</div>
                    <div class="text-xs text-gray-500">Status: {{ titulo.status }}</div>
                </div>
                {% endfor %}
                {% if titulos_data|length == 0 %}
                <div class="text-sm text-gray-500 text-center py-6">Nenhum titulo selecionado.</div>
                {% endif %}
            </div>
        </aside>
        <section class="lg:col-span-3">
            <div class="h-full rounded-lg border border-gray-200 bg-slate-50 p-2">
                {% if titulos %}
                    {% for titulo in titulos %}
                    <iframe
                        class="boleto-frame w-full h-[70vh] rounded-md border border-gray-200 bg-white {% if not loop.first %}hidden{% endif %}"
                        data-index="{{ loop.index0 }}"
                        src="{{ url_for('contas_receber.visualizar_boleto', conta_id=titulo.id) }}"
                        title="Boleto #{{ titulo.id }}"
                        loading="lazy"
                    ></iframe>
                    {% endfor %}
                {% else %}
                <div class="flex flex-col items-center justify-center text-center text-gray-500 h-full py-16">
                    <i class="fas fa-barcode text-5xl mb-4"></i>
                    <p>Nenhum boleto disponivel para exibir.</p>
                </div>
                {% endif %}
            </div>
        </section>
    </div>

    <div id="downloads" class="mt-6 hidden">
        <div class="border border-gray-200 bg-slate-50 rounded-lg p-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-2">
                <h3 class="text-lg font-semibold text-dark-blue">Arquivos gerados</h3>
                <button
                    id="btnDownloadAll"
                    type="button"
                    class="btn-secondary flex items-center justify-center gap-2 hidden"
                >
                    <i class="fas fa-download"></i>
                    <span>Baixar todos</span>
                </button>
            </div>
            <ul id="downloadList" class="space-y-2 text-sm"></ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function(){
    const ids = {{ ids|tojson }};
    const total = {{ titulos|length }};
    const frames = Array.from(document.querySelectorAll('.boleto-frame'));
    const items = Array.from(document.querySelectorAll('.titulo-item'));
    const indicator = document.getElementById('pageIndicator');
    const feedback = document.getElementById('feedback');
    const downloadsWrapper = document.getElementById('downloads');
    const downloadList = document.getElementById('downloadList');
    const btnDownloadAll = document.getElementById('btnDownloadAll');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const btnGenerate = document.getElementById('btnGenerate');
    const btnGenerateOriginalHTML = btnGenerate ? btnGenerate.innerHTML : '';
    const btnDownloadAllOriginalHTML = btnDownloadAll ? btnDownloadAll.innerHTML : '';
    let current = 0;
    let generatedFiles = [];

    function updateIndicator(index){
        if (!indicator) { return; }
        indicator.textContent = (total ? index + 1 : 0) + ' / ' + total;
    }

    function updateNavState(){
        if (btnPrev) { btnPrev.disabled = current <= 0; }
        if (btnNext) { btnNext.disabled = current >= frames.length - 1; }
    }

    function highlightItem(index){
        items.forEach((item, idx) => {
            if (idx === index) {
                item.classList.add('border-indigo-500', 'shadow-md', 'bg-indigo-50');
            } else {
                item.classList.remove('border-indigo-500', 'shadow-md', 'bg-indigo-50');
            }
        });
    }

    function showFrame(index){
        if (!frames.length) {
            updateIndicator(0);
            updateNavState();
            return;
        }
        if (index < 0) { index = 0; }
        if (index >= frames.length) { index = frames.length - 1; }
        frames.forEach((frame, idx) => {
            if (idx === index) {
                frame.classList.remove('hidden');
            } else {
                frame.classList.add('hidden');
            }
        });
        highlightItem(index);
        current = index;
        updateIndicator(current);
        updateNavState();
    }

    function clearFeedback(){
        if (feedback) {
            feedback.textContent = '';
            feedback.classList.remove('text-green-600', 'text-red-600');
        }
    }

    function setFeedback(message, type){
        if (!feedback) { return; }
        feedback.textContent = message || '';
        feedback.classList.remove('text-green-600', 'text-red-600');
        if (type === 'success') {
            feedback.classList.add('text-green-600');
        } else if (type === 'error') {
            feedback.classList.add('text-red-600');
        }
    }

    if (btnPrev) {
        btnPrev.addEventListener('click', function(){
            showFrame(current - 1);
        });
    }

    if (btnNext) {
        btnNext.addEventListener('click', function(){
            showFrame(current + 1);
        });
    }

    items.forEach(function(item){
        item.addEventListener('click', function(){
            const idx = parseInt(item.dataset.index, 10);
            if (!Number.isNaN(idx)) {
                showFrame(idx);
            }
        });
    });

    function getFileNameFromContentDisposition(disposition){
        if (!disposition) { return ''; }
        const filenameRegex = /filename\*=UTF-8''([^;]+)|filename="([^"]+)"/i;
        const match = disposition.match(filenameRegex);
        if (match) {
            const value = match[1] || match[2] || '';
            try {
                return decodeURIComponent(value);
            } catch (err) {
                return value;
            }
        }
        return '';
    }

    function getExtensionFromContentType(contentType){
        if (!contentType) { return ''; }
        if (contentType.includes('pdf')) { return '.pdf'; }
        if (contentType.includes('text/plain')) { return '.txt'; }
        if (contentType.includes('json')) { return '.json'; }
        if (contentType.includes('zip')) { return '.zip'; }
        return '';
    }

    function sanitizeFileName(label){
        if (!label) { return 'arquivo'; }
        const normalized = label.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9_.-]/g, '');
        return normalized || 'arquivo';
    }

    async function downloadFile(file){
        const response = await fetch(file.url, { credentials: 'same-origin' });
        if (!response.ok) {
            throw new Error('Falha ao baixar ' + file.label);
        }
        const blob = await response.blob();
        let filename = getFileNameFromContentDisposition(response.headers.get('Content-Disposition'));
        if (!filename) {
            try {
                const urlObj = new URL(file.url, window.location.href);
                const pathSegments = urlObj.pathname.split('/').filter(Boolean);
                const lastSegment = pathSegments[pathSegments.length - 1] || '';
                filename = lastSegment;
            } catch (err) {
                filename = '';
            }
        }
        if (!filename || !filename.includes('.')) {
            const extension = getExtensionFromContentType(response.headers.get('Content-Type'));
            filename = sanitizeFileName(file.label) + (extension || '');
        }
        const blobUrl = URL.createObjectURL(blob);
        const anchor = document.createElement('a');
        anchor.href = blobUrl;
        anchor.download = filename;
        document.body.appendChild(anchor);
        anchor.click();
        document.body.removeChild(anchor);
        URL.revokeObjectURL(blobUrl);
    }

    async function downloadAllFiles(){
        if (!generatedFiles.length || !btnDownloadAll) { return; }
        clearFeedback();
        btnDownloadAll.disabled = true;
        btnDownloadAll.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Baixando...</span>';
        try {
            for (const file of generatedFiles) {
                await downloadFile(file);
            }
            setFeedback('Downloads iniciados para todos os arquivos.', 'success');
        } catch (err) {
            setFeedback((err && err.message) ? err.message : 'Falha ao baixar os arquivos.', 'error');
        } finally {
            btnDownloadAll.disabled = false;
            btnDownloadAll.innerHTML = btnDownloadAllOriginalHTML;
        }
    }

    if (btnDownloadAll) {
        btnDownloadAll.addEventListener('click', downloadAllFiles);
    }

    function renderDownloads(data){
        if (!downloadsWrapper || !downloadList) { return; }
        downloadList.innerHTML = '';
        const links = [];
        (data.pdf_urls || []).forEach(function(url, idx){
            links.push({ url: url, label: 'Boleto PDF ' + (idx + 1) });
        });
        if (data.remessa_url) {
            links.push({ url: data.remessa_url, label: 'Arquivo de remessa' });
        }
        generatedFiles = links.slice();
        links.forEach(function(file){
            const li = document.createElement('li');
            const anchor = document.createElement('a');
            anchor.href = file.url;
            anchor.target = '_blank';
            anchor.rel = 'noopener';
            anchor.className = 'text-indigo-600 hover:text-indigo-800 font-semibold flex items-center gap-2';
            anchor.innerHTML = '<i class="fas fa-file-alt"></i>' + file.label;
            li.appendChild(anchor);
            downloadList.appendChild(li);
        });
        if (links.length) {
            downloadsWrapper.classList.remove('hidden');
            if (btnDownloadAll) {
                btnDownloadAll.classList.remove('hidden');
                btnDownloadAll.disabled = false;
                btnDownloadAll.innerHTML = btnDownloadAllOriginalHTML;
            }
        } else {
            generatedFiles = [];
            if (btnDownloadAll) {
                btnDownloadAll.classList.add('hidden');
            }
        }
    }

    if (btnGenerate) {
        btnGenerate.addEventListener('click', async function(){
            clearFeedback();
            if (!ids || !ids.length) {
                setFeedback('Nenhum titulo selecionado para geracao.', 'error');
                return;
            }
            if (downloadsWrapper) {
                downloadsWrapper.classList.add('hidden');
            }
            if (downloadList) {
                downloadList.innerHTML = '';
            }
            generatedFiles = [];
            if (btnDownloadAll) {
                btnDownloadAll.classList.add('hidden');
            }
            btnGenerate.disabled = true;
            btnGenerate.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Gerando...</span>';
            try {
                const response = await fetch('/api/contas-receber/boleto/lote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: ids })
                });
                const data = await response.json().catch(function(){ return {}; });
                if (!response.ok) {
                    setFeedback(data.error || 'Falha ao gerar boletos.', 'error');
                } else {
                    setFeedback('Boletos gerados com sucesso.', 'success');
                    renderDownloads(data);
                }
            } catch (err) {
                setFeedback((err && err.message) ? err.message : 'Falha ao gerar boletos.', 'error');
            } finally {
                btnGenerate.disabled = false;
                btnGenerate.innerHTML = btnGenerateOriginalHTML;
            }
        });
    }

    showFrame(0);
})();
</script>
{% endblock %}
