<!-- templates/contratos/list.html -->
{% extends "base.html" %}

{% block title %}Contratos de Aluguel{% endblock %}

{% block page_title %}Contratos de Aluguel{% endblock %}

{% block content %}
<div class="bg-white p-6 rounded-lg shadow-xl content-section">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-semibold text-dark-blue">Lista de Contratos</h2>
        <a href="{{ url_for('contratos_add') }}" class="btn-primary text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center justify-center">
            <i class="fas fa-plus mr-2"></i> Novo Contrato
        </a>
    </div>
    {# Campo de busca geral removido. Usaremos busca por coluna no cabeçalho. #}
    {% if contratos %}
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-lg overflow-hidden">
            <thead class="text-white" style="background-color: var(--clr-sidebar-bg);">
                <tr>
                    <th class="py-3 px-4 text-left text-sm font-semibold text-white">ID</th>
                    <th class="py-3 px-4 text-left text-sm font-semibold text-white">ID Imovel</th>
                    <th class="py-3 px-4 text-left text-sm font-semibold text-white">Imóvel</th>
                    <th class="py-3 px-4 text-left text-sm font-semibold text-white">Inquilino</th>
                    <th class="py-3 px-4 text-left text-sm font-semibold text-white">Finalidade</th>
                    <th class="py-3 px-4 text-left text-sm font-semibold text-white">Período</th>
                    <th class="py-3 px-4 text-left text-sm font-semibold text-white">Valor Parcela</th>
                    <th class="py-3 px-4 text-left text-sm font-semibold text-white">Status</th>
                    <th class="py-3 px-4 text-left text-sm font-semibold text-white">Ações</th>
                </tr>
                <tr>
                    <th class="py-2 px-4"><input type="text" class="form-input column-search w-full min-w-0" placeholder="Buscar"></th>
                    <th class="py-2 px-4"><input type="text" class="form-input column-search w-full min-w-0" placeholder="Buscar"></th>
                    <th class="py-2 px-4"><input type="text" class="form-input column-search w-full min-w-0" placeholder="Buscar"></th>
                    <th class="py-2 px-4"><input type="text" class="form-input column-search w-full min-w-0" placeholder="Buscar"></th>
                    <th class="py-2 px-4"><input type="text" class="form-input column-search w-full min-w-0" placeholder="Buscar"></th>
                    <th class="py-2 px-4"><input type="text" class="form-input column-search w-full min-w-0" placeholder="Buscar"></th>
                    <th class="py-2 px-4"><input type="text" class="form-input column-search w-full min-w-0" placeholder="Buscar"></th>
                    <th class="py-2 px-4"><input type="text" class="form-input column-search w-full min-w-0" placeholder="Buscar"></th>
                    <th class="py-2 px-4"></th>
                </tr>
            </thead>
            <tbody id="contratos-tbody">
                {% for contrato in contratos %}
                <tr class="{{ loop.cycle('table-row-odd','table-row-even') }} border-b border-gray-200 hover:bg-gray-50">
                    <td class="py-3 px-4 text-sm text-gray-700">{{ contrato.id }}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">{{ contrato.imovel_id }}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">{{ contrato.endereco_imovel }}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">{{ contrato.nome_inquilino }}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">{{ contrato.finalidade }}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">{{ contrato.data_inicio.strftime('%d/%m/%Y') }} - {{ contrato.data_fim.strftime('%d/%m/%Y') }}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">R$ {{ "%.2f"|format(contrato.valor_parcela) }}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">{{ contrato.status_contrato }}</td>
                    <td class="py-3 px-4 text-sm">
                        <a href="#" onclick="openModeloModal({{ contrato.id }}); return false;" class="text-green-600 hover:text-green-800 mr-3" title="Gerar Contrato"><i class="fas fa-file-signature"></i></a>
                        <a href="{{ url_for('contratos_renovar', contrato_id=contrato.id) }}" class="text-indigo-600 hover:text-indigo-800 mr-3" title="Renovar Contrato">
                            <i class="fas fa-sync-alt"></i>
                        </a>
                        <a href="{{ url_for('contratos_edit', id=contrato.id) }}" class="text-blue-600 hover:text-blue-800 mr-3" title="Editar"><i class="fas fa-edit"></i></a>
                        <a href="{{ url_for('contratos_prestacoes_list', contrato_id=contrato.id) }}" class="text-yellow-600 hover:text-yellow-800 mr-3" title="Prestação de contas / Encerrar">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </a>
                        <form action="{{ url_for('contratos_delete', id=contrato.id) }}" method="POST" class="inline-block" onsubmit="return confirm('Tem certeza que deseja excluir este contrato e todos os seus anexos?');">
                            <button type="submit" class="text-red-600 hover:text-red-800" title="Excluir"><i class="fas fa-trash-alt"></i></button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-center text-gray-600">Nenhum contrato encontrado.</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    const inputs = document.querySelectorAll('.column-search');
    const rows = document.querySelectorAll('#contratos-tbody tr');
    function filterTable(){
        rows.forEach(row => {
            let visible = true;
            inputs.forEach((input, index) => {
                const filter = (input.value || '').toLowerCase();
                const cell = row.querySelectorAll('td')[index];
                if(filter && cell && !cell.textContent.toLowerCase().includes(filter)){
                    visible = false;
                }
            });
            row.style.display = visible ? '' : 'none';
        });
    }
    inputs.forEach(input => input.addEventListener('input', filterTable));
});
</script>
<script>
// Modal de selecao de modelo de contrato
let selectedContratoId = null;
function openModeloModal(contratoId){
    selectedContratoId = contratoId;
    const modal = document.getElementById('modal-modelos');
    if(modal){ modal.style.display = 'flex'; }
}
function closeModeloModal(){
    const modal = document.getElementById('modal-modelos');
    if(modal){ modal.style.display = 'none'; }
}
function confirmarModelo(){
    const selected = document.querySelector('input[name="modelo_id"]:checked');
    if(!selected){
        alert('Selecione um modelo de contrato.');
        return;
    }
    const modeloId = selected.value;
    const base = "{{ url_for('contrato_preview', contrato_id=0) }}";
    const previewUrl = base.replace(/\/?0$/, '') + '/' + selectedContratoId + '?modelo_id=' + modeloId;
    window.location.href = previewUrl;
}
</script>

<!-- Modal: Seleção de Modelo de Contrato -->
<div id="modal-modelos" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="text-lg font-semibold">Selecionar Modelo de Contrato</h3>
      <button onclick="closeModeloModal()" title="Fechar" class="text-white">&times;</button>
    </div>
    <div class="modal-body">
      {% if modelos and modelos|length > 0 %}
      <div class="space-y-2">
        {% for modelo in modelos %}
        <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-100 cursor-pointer">
          <input type="radio" name="modelo_id" value="{{ modelo.id }}">
          <span class="text-sm text-gray-800">{{ modelo.nome }}</span>
        </label>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-sm text-gray-700">Nenhum modelo de contrato cadastrado.</p>
      {% endif %}
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeModeloModal()">Cancelar</button>
      <button class="btn-primary text-white" onclick="confirmarModelo()">Pré-visualizar</button>
    </div>
  </div>
  <!-- Fecha modal ao clicar fora -->
  <script>
    document.getElementById('modal-modelos').addEventListener('click', function(e){
        if(e.target === this){ closeModeloModal(); }
    });
  </script>
</div>
{% endblock %}
