<!-- templates/contratos/list.html -->
{% extends "base.html" %}

{% block title %}Contratos de Aluguel{% endblock %}

{% block page_title %}Contratos de Aluguel{% endblock %}

{% block content %}
<div class="bg-white p-6 rounded-lg shadow-xl content-section">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-semibold text-dark-blue">Lista de Contratos</h2>
        <a href="{{ url_for('contratos_add') }}" class="btn-primary text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center justify-center">
            <i class="fas fa-plus mr-2"></i> Novo Contrato
        </a>
    </div>
    {# Campo de busca geral removido. Usaremos busca por coluna no cabeÃ§alho. #}
    {% if contratos %}
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-lg overflow-hidden">
            <thead class="text-white" style="background-color: var(--clr-sidebar-bg);">
                <tr>
                    <th class="py-3 px-4 text-left text-sm font-semibold text-white">ID</th>
                    <th class="py-3 px-4 text-left text-sm font-semibold text-white">ImÃ³vel</th>
                    <th class="py-3 px-4 text-left text-sm font-semibold text-white">Inquilino</th>
                    <th class="py-3 px-4 text-left text-sm font-semibold text-white">Finalidade</th>
                    <th class="py-3 px-4 text-left text-sm font-semibold text-white">PerÃ­odo</th>
                    <th class="py-3 px-4 text-left text-sm font-semibold text-white">Valor Parcela</th>
                    <th class="py-3 px-4 text-left text-sm font-semibold text-white">Status</th>
                    <th class="py-3 px-4 text-left text-sm font-semibold text-white">AÃ§Ãµes</th>
                </tr>
                <tr>
                    <th class="py-2 px-4"><input type="text" class="form-input column-search w-full min-w-0" placeholder="Buscar"></th>
                    <th class="py-2 px-4"><input type="text" class="form-input column-search w-full min-w-0" placeholder="Buscar"></th>
                    <th class="py-2 px-4"><input type="text" class="form-input column-search w-full min-w-0" placeholder="Buscar"></th>
                    <th class="py-2 px-4"><input type="text" class="form-input column-search w-full min-w-0" placeholder="Buscar"></th>
                    <th class="py-2 px-4"><input type="text" class="form-input column-search w-full min-w-0" placeholder="Buscar"></th>
                    <th class="py-2 px-4"><input type="text" class="form-input column-search w-full min-w-0" placeholder="Buscar"></th>
                    <th class="py-2 px-4"><input type="text" class="form-input column-search w-full min-w-0" placeholder="Buscar"></th>
                    <th class="py-2 px-4"></th>
                </tr>
            </thead>
            <tbody id="contratos-tbody">
                {% for contrato in contratos %}
                <tr class="{{ loop.cycle('table-row-odd','table-row-even') }} border-b border-gray-200 hover:bg-gray-50">
                    <td class="py-3 px-4 text-sm text-gray-700">{{ contrato.id }}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">{{ contrato.endereco_imovel }}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">{{ contrato.nome_inquilino }}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">{{ contrato.finalidade }}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">{{ contrato.data_inicio.strftime('%d/%m/%Y') }} - {{ contrato.data_fim.strftime('%d/%m/%Y') }}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">R$ {{ "%.2f"|format(contrato.valor_parcela) }}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">{{ contrato.status_contrato }}</td>
                    <td class="py-3 px-4 text-sm">
                        <a href="#" onclick="openModeloModal({{ contrato.id }}); return false;" class="text-green-600 hover:text-green-800 mr-3" title="Gerar Contrato"><i class="fas fa-file-signature"></i></a>
                        <a href="{{ url_for('contratos_edit', id=contrato.id) }}" class="text-blue-600 hover:text-blue-800 mr-3" title="Editar"><i class="fas fa-edit"></i></a>
                        {% if contrato.status_contrato != 'Encerrado' %}
                        <button type="button" class="text-yellow-600 hover:text-yellow-800 mr-3 inline-flex items-center" title="Encerrar" data-contrato-id="{{ contrato.id }}" data-data-fim='{{ contrato.data_fim.strftime("%Y-%m-%d") if contrato.data_fim else "" }}' onclick="openEncerrarModal(this)">
                            <i class="fas fa-ban"></i>
                        </button>
                        {% endif %}
                        <form action="{{ url_for('contratos_delete', id=contrato.id) }}" method="POST" class="inline-block" onsubmit="return confirm('Tem certeza que deseja excluir este contrato e todos os seus anexos?');">
                            <button type="submit" class="text-red-600 hover:text-red-800" title="Excluir"><i class="fas fa-trash-alt"></i></button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-center text-gray-600">Nenhum contrato encontrado.</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    const inputs = document.querySelectorAll('.column-search');
    const rows = document.querySelectorAll('#contratos-tbody tr');
    function filterTable(){
        rows.forEach(row => {
            let visible = true;
            inputs.forEach((input, index) => {
                const filter = (input.value || '').toLowerCase();
                const cell = row.querySelectorAll('td')[index];
                if(filter && cell && !cell.textContent.toLowerCase().includes(filter)){
                    visible = false;
                }
            });
            row.style.display = visible ? '' : 'none';
        });
    }
    inputs.forEach(input => input.addEventListener('input', filterTable));
});
</script>
<script>
// Modal de seleÃ§Ã£o de modelo de contrato
let selectedContratoId = null;
function openModeloModal(contratoId){
    selectedContratoId = contratoId;
    const modal = document.getElementById('modal-modelos');
    if(modal){ modal.classList.remove('hidden'); }
}
function closeModeloModal(){
    const modal = document.getElementById('modal-modelos');
    if(modal){ modal.classList.add('hidden'); }
}
function confirmarModelo(){
    const selected = document.querySelector('input[name="modelo_id"]:checked');
    if(!selected){
        alert('Selecione um modelo de contrato.');
        return;
    }
    const modeloId = selected.value;
    const base = "{{ url_for('contrato_preview', contrato_id=0) }}"; // '/contratos/preview/0'
    const previewUrl = base.replace(/\/?0$/, '') + '/' + selectedContratoId + '?modelo_id=' + modeloId;
    window.location.href = previewUrl;
}

function openEncerrarModal(trigger){
    if(!trigger || !trigger.dataset){
        return;
    }
    const modal = document.getElementById('modal-encerrar');
    const form = document.getElementById('encerrar-form');
    const dateInput = document.getElementById('data_encerramento_input');
    const contratoSpan = document.getElementById('encerrar-contrato-id');

    if(!modal || !form || !dateInput){
        return;
    }

    const contratoId = trigger.dataset.contratoId;
    if(!contratoId){
        return;
    }

    const baseAction = form.dataset.baseAction || '';
    if(baseAction){
        form.action = baseAction.replace(/0$/, contratoId);
    }
    if(contratoSpan){
        contratoSpan.textContent = contratoId;
    }

    const dataFimAtual = trigger.dataset.dataFim || '';
    const hoje = new Date().toISOString().split('T')[0];
    dateInput.value = dataFimAtual || hoje;
    dateInput.max = hoje;

    modal.classList.remove('hidden');
    dateInput.focus();
}

function closeEncerrarModal(){
    const modal = document.getElementById('modal-encerrar');
    if(modal){
        modal.classList.add('hidden');
    }
}

</script>

<style>
/* Estilo simples de modal; segue paleta existente */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background: #fff; border-radius: 0.5rem; width: 100%; max-width: 600px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
.modal-header { padding: 1rem 1.25rem; background-color: var(--clr-sidebar-bg); color: #fff; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; display: flex; align-items: center; justify-content: space-between; }
.modal-body { padding: 1rem 1.25rem; max-height: 60vh; overflow-y: auto; }
.modal-footer { padding: 0.75rem 1.25rem; display: flex; justify-content: flex-end; gap: 0.5rem; }
.hidden { display: none; }
</style>

<!-- Modal: Encerrar Contrato -->
<div id="modal-encerrar" class="modal-overlay hidden">
  <div class="modal-content">
    <form id="encerrar-form" method="POST" data-base-action="{{ url_for('contratos_encerrar', id=0) }}">
      <div class="modal-header">
        <h3 class="text-lg font-semibold">Encerrar Contrato</h3>
        <button type="button" onclick="closeEncerrarModal()" title="Fechar" class="text-white">&times;</button>
      </div>
      <div class="modal-body">
        <p class="text-sm text-gray-700 mb-4">Informe a data de encerramento para o contrato <span id="encerrar-contrato-id" class="font-semibold"></span>.</p>
        <label for="data_encerramento_input" class="form-label">Data de Encerramento:</label>
        <input type="date" id="data_encerramento_input" name="data_encerramento" class="form-input w-full" required>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="closeEncerrarModal()">Cancelar</button>
        <button type="submit" class="btn-primary text-white">Encerrar</button>
      </div>
    </form>
  </div>
  <script>
    document.getElementById('modal-encerrar').addEventListener('click', function(e){
        if(e.target === this){ closeEncerrarModal(); }
    });
  </script>
</div>

<!-- Modal: SeleÃ§Ã£o de Modelo de Contrato -->
<div id="modal-modelos" class="modal-overlay hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="text-lg font-semibold">Selecionar Modelo de Contrato</h3>
      <button onclick="closeModeloModal()" title="Fechar" class="text-white">&times;</button>
    </div>
    <div class="modal-body">
      {% if modelos and modelos|length > 0 %}
      <div class="space-y-2">
        {% for modelo in modelos %}
        <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-100 cursor-pointer">
          <input type="radio" name="modelo_id" value="{{ modelo.id }}">
          <span class="text-sm text-gray-800">{{ modelo.nome }}</span>
        </label>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-sm text-gray-700">Nenhum modelo de contrato cadastrado.</p>
      {% endif %}
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeModeloModal()">Cancelar</button>
      <button class="btn-primary text-white" onclick="confirmarModelo()">PrÃ©-visualizar</button>
    </div>
  </div>
  <!-- Fecha modal ao clicar fora -->
  <script>
    document.getElementById('modal-modelos').addEventListener('click', function(e){
        if(e.target === this){ closeModeloModal(); }
    });
  </script>
</div>
{% endblock %}
