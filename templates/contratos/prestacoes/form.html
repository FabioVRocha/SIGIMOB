{% extends "base.html" %}

{% block title %}PrestaÃ§Ã£o de Contas do Contrato{% endblock %}

{% block page_title %}PrestaÃ§Ã£o de Contas do Contrato{% endblock %}

{% block content %}
<div class="content-section bg-white p-6 rounded-lg shadow-xl space-y-6">
    <div class="flex justify-between items-start flex-wrap gap-4">
        <div>
            <h2 class="text-2xl font-semibold text-dark-blue mb-2">Contrato #{{ contrato.id }}</h2>
            <p class="text-sm text-gray-700"><strong>Cliente:</strong> {{ contrato.cliente_nome }} ({{ contrato.cliente_documento }})</p>
            <p class="text-sm text-gray-700"><strong>ImÃ³vel:</strong> {{ contrato.imovel_endereco }} - {{ contrato.imovel_cidade }}/{{ contrato.imovel_estado }}</p>
            <p class="text-sm text-gray-700"><strong>PerÃ­odo:</strong> {{ contrato.data_inicio.strftime('%d/%m/%Y') }} atÃ© {{ contrato.data_fim.strftime('%d/%m/%Y') }}</p>
            {% if prestacao %}
            <div class="mt-2">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold {% if prestacao.status == "Aprovada" %}bg-green-100 text-green-700{% elif prestacao.status == "Pendente" %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-700{% endif %}">
                    Status: {{ prestacao.status or 'Pendente' }}
                </span>
                {% if prestacao.status == "Pendente" %}
                <p class="text-xs text-gray-600 mt-1">Ap?s salvar, aprove a presta??o para gerar as contas financeiras.</p>
                {% else %}
                <p class="text-xs text-gray-600 mt-1">Ao salvar altera??es, a presta??o voltar? para pendente e precisar? ser aprovada novamente.</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
        <div class="text-right">
            <a href="{{ url_for('contratos_prestacoes_list', contrato_id=contrato.id) }}" class="btn-secondary inline-flex items-center"><i class="fas fa-arrow-left mr-2"></i>Voltar para prestacoes</a>
        </div>
    </div>

    <form id="prestacao-form" method="POST" action="{{ form_action }}" class="space-y-6">
        <input type="hidden" name="prestacao_payload" id="prestacao-payload">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="prestacao-data" class="form-label">Data de encerramento</label>
                <input type="date" id="prestacao-data" name="data_encerramento" class="form-input" value="{{ data_encerramento }}" required>
            </div>
            <div class="md:text-right text-sm text-gray-600 flex items-end justify-start md:justify-end">
                <span id="prestacao-feedback" class="hidden"></span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="border border-gray-200 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">CrÃ©ditos (CalÃ§Ã£o)</h3>
                <div id="creditos-container" class="space-y-2 text-sm"></div>
            </div>
            <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-gray-800">DÃ©bitos pendentes</h3>
                    <span class="text-xs text-gray-500">Selecione as parcelas a incluir ou marque as que deseja desconsiderar</span>
                </div>
                <div id="debitos-container" class="space-y-2 text-sm"></div>
            </div>
        </div>

        <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold text-gray-800">Creditos extras</h3>
                <button type="button" id="add-credito-extra" class="btn-secondary text-sm"><i class="fas fa-plus mr-2"></i>Adicionar credito</button>
            </div>
            <p class="text-xs text-gray-500 mb-3">Valores positivos adicionados manualmente serao somados aos creditos do resumo.</p>
            <div id="creditos-extras-container" class="space-y-3 text-sm"></div>
        </div>

        <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold text-gray-800">Despesas extras</h3>
                <button type="button" id="add-despesa" class="btn-secondary text-sm"><i class="fas fa-plus mr-2"></i>Adicionar despesa</button>
            </div>
            <div id="despesas-container" class="space-y-3 text-sm"></div>
        </div>

        <div>
            <label for="prestacao-observacoes" class="form-label">ObservaÃ§Ãµes</label>
            <textarea id="prestacao-observacoes" name="observacoes" rows="4" class="form-input" placeholder="AnotaÃ§Ãµes gerais para a prestaÃ§Ã£o de contas"></textarea>
        </div>

        <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Resumo</h3>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 text-sm text-gray-700">
                <div>
                    <p class="font-medium">Total de crÃ©ditos</p>
                    <p id="total-creditos" class="text-lg font-semibold text-green-600">R$ 0,00</p>
                </div>
                <div>
                    <p class="font-medium">Creditos extras</p>
                    <p id="total-creditos-extras" class="text-lg font-semibold text-green-600">R$ 0,00</p>
                </div>
                <div>
                    <p class="font-medium">Total de dÃ©bitos</p>
                    <p id="total-debitos" class="text-lg font-semibold text-red-600">R$ 0,00</p>
                </div>
                <div>
                    <p class="font-medium">Despesas extras</p>
                    <p id="total-despesas" class="text-lg font-semibold text-red-600">R$ 0,00</p>
                </div>
                <div>
                    <p class="font-medium">Saldo final</p>
                    <p id="saldo-final" class="text-lg font-semibold">R$ 0,00</p>
                </div>
            </div>
            <p id="saldo-feedback" class="text-sm mt-3 text-gray-600"></p>
        </div>

        <div class="flex items-center justify-end gap-3">
            <a href="{{ url_for('contratos_list') }}" class="btn-secondary">Cancelar</a>
            <button type="submit" class="btn-primary text-white">
                {% if is_edit %}Atualizar prestaÃ§Ã£o de contas{% else %}Gerar prestaÃ§Ã£o de contas{% endif %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
    const previewUrl = "{{ preview_url }}";
    const initialDate = "{{ data_encerramento }}";
    const configuracao = {{ configuracao | tojson }};

    const dataInput = document.getElementById('prestacao-data');
    const creditosContainer = document.getElementById('creditos-container');
    const creditosExtrasContainer = document.getElementById('creditos-extras-container');
    const debitosContainer = document.getElementById('debitos-container');
    const despesasContainer = document.getElementById('despesas-container');
    const addDespesaBtn = document.getElementById('add-despesa');
    const addCreditoExtraBtn = document.getElementById('add-credito-extra');
    const observacoesTextarea = document.getElementById('prestacao-observacoes');
    const payloadInput = document.getElementById('prestacao-payload');
    const totalCreditosEl = document.getElementById('total-creditos');
    const totalCreditosExtrasEl = document.getElementById('total-creditos-extras');
    const totalDebitosEl = document.getElementById('total-debitos');
    const totalDespesasEl = document.getElementById('total-despesas');
    const saldoFinalEl = document.getElementById('saldo-final');
    const saldoFeedbackEl = document.getElementById('saldo-feedback');
    const feedbackEl = document.getElementById('prestacao-feedback');

    const state = {
        creditos: [],
        debitos: [],
        selectedDebitos: new Set(),
        cancelledDebitos: new Set(),
        creditosExtras: [],
        despesas: [],
    };

    if (Array.isArray(configuracao.selectedDebitos)) {
        configuracao.selectedDebitos.forEach(id => {
            const numericId = parseInt(id, 10);
            if (!Number.isNaN(numericId)) {
                state.selectedDebitos.add(numericId);
            }
        });
    }

    if (Array.isArray(configuracao.cancelledDebitos)) {
        configuracao.cancelledDebitos.forEach(id => {
            const numericId = parseInt(id, 10);
            if (!Number.isNaN(numericId)) {
                state.cancelledDebitos.add(numericId);
                state.selectedDebitos.delete(numericId);
            }
        });
    }

    if (Array.isArray(configuracao.creditosExtras)) {
        state.creditosExtras = configuracao.creditosExtras.map((item, index) => ({
            id: `credito-extra-${index + 1}`,
            descricao: item.descricao || '',
            valor: item.valor || ''
        }));
    }

if (Array.isArray(configuracao.despesas)) {
        state.despesas = configuracao.despesas.map((item, index) => ({
            id: `despesa-${index + 1}`,
            descricao: item.descricao || '',
            valor: item.valor || ''
        }));
    }

    if (observacoesTextarea) {
        observacoesTextarea.value = configuracao.observacoes || '';
    }

    function formatCurrency(value){
        const numero = Number(value || 0);
        if(!Number.isFinite(numero)){
            return 'R$ 0,00';
        }
        return numero.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function parseValor(valor){
        if(typeof valor === 'number'){
            return valor;
        }
        if(typeof valor !== 'string'){
            return 0;
        }
        
        const cleaned = valor.replace(/[^0-9.,-]/g, '');
        const hasComma = cleaned.includes(',');
        const hasDot = cleaned.includes('.');

        let normalized;
        if(hasComma && hasDot){
            normalized = cleaned.replace(/\./g, '').replace(',', '.');
        }else if(hasComma){
            normalized = cleaned.replace(',', '.');
        }else{
            normalized = cleaned;
        }

        const parsed = parseFloat(normalized);
        return Number.isFinite(parsed) ? parsed : 0;
    }

    function renderCreditos(){
        if(!creditosContainer){ return; }
        if(!state.creditos.length){
            creditosContainer.innerHTML = '<p class="text-gray-500 text-sm">Nenhum crÃ©dito encontrado.</p>';
            return;
        }
        const rows = state.creditos.map(item => `
            <div class="border border-gray-200 rounded p-2 flex justify-between items-center">
                <div>
                    <p class="font-medium text-gray-800">${item.titulo}</p>
                    <p class="text-xs text-gray-500">Pagamento: ${item.data_pagamento_formatada || 'â€”'}</p>
                </div>
                <div class="font-semibold text-green-600">${item.valor_formatado}</div>
            </div>
        `);
        creditosContainer.innerHTML = rows.join('');
    }

    function renderDebitos(){
        if(!debitosContainer){ return; }
        if(!state.debitos.length){
            debitosContainer.innerHTML = '<p class="text-gray-500 text-sm">Nenhum débito encontrado para a data informada.</p>';
            return;
        }
        const idsDisponiveis = new Set(state.debitos.map(item => item.id));
        state.selectedDebitos = new Set([...state.selectedDebitos].filter(id => idsDisponiveis.has(id)));
        state.cancelledDebitos = new Set([...state.cancelledDebitos].filter(id => idsDisponiveis.has(id)));

        const rows = state.debitos.map(item => {
            const isCancelled = state.cancelledDebitos.has(item.id);
            const isSelected = !isCancelled && state.selectedDebitos.has(item.id);
            return `
                <div class="border border-gray-200 rounded p-3 hover:bg-gray-50 transition" data-debito-id="${item.id}">
                    <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                        <label class="flex items-start gap-3 flex-1 cursor-pointer">
                            <input type="checkbox" class="mt-1 seleciona-debito" value="${item.id}" ${isSelected ? 'checked' : ''}>
                            <div class="flex-1">
                                <p class="font-medium text-gray-800">${item.titulo}</p>
                                <p class="text-xs text-gray-500">Vencimento: ${item.data_vencimento_formatada || '-'} | Valor pendente: ${item.valor_pendente_formatado}</p>
                            </div>
                        </label>
                        <label class="flex items-center gap-2 text-xs text-gray-600">
                            <input type="checkbox" class="ignora-debito" value="${item.id}" ${isCancelled ? 'checked' : ''}>
                            Desconsiderar
                        </label>
                    </div>
                </div>
            `;
        });
        debitosContainer.innerHTML = rows.join('');
        debitosContainer.querySelectorAll('.seleciona-debito').forEach(input => {
            input.addEventListener('change', () => {
                const id = parseInt(input.value, 10);
                if(Number.isNaN(id)){ return; }
                if(input.checked){
                    state.selectedDebitos.add(id);
                    if(state.cancelledDebitos.has(id)){
                        state.cancelledDebitos.delete(id);
                        const cancelInput = input.closest('[data-debito-id]').querySelector('.ignora-debito');
                        if(cancelInput){ cancelInput.checked = false; }
                    }
                }else{
                    state.selectedDebitos.delete(id);
                }
                atualizarTotais();
            });
        });
        debitosContainer.querySelectorAll('.ignora-debito').forEach(input => {
            input.addEventListener('change', () => {
                const id = parseInt(input.value, 10);
                if(Number.isNaN(id)){ return; }
                const includeInput = input.closest('[data-debito-id]').querySelector('.seleciona-debito');
                if(input.checked){
                    state.cancelledDebitos.add(id);
                    state.selectedDebitos.delete(id);
                    if(includeInput){
                        includeInput.checked = false;
                    }
                }else{
                    state.cancelledDebitos.delete(id);
                }
                atualizarTotais();
            });
        });
    }


    function renderCreditosExtras(){
        if(!creditosExtrasContainer){ return; }
        if(!state.creditosExtras.length){
            creditosExtrasContainer.innerHTML = '<p class="text-sm text-gray-500">Nenhum credito extra adicionado.</p>';
            return;
        }
        const rows = state.creditosExtras.map(item => `
            <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end border border-gray-200 rounded p-3" data-credito-extra-id="${item.id}">
                <div class="md:col-span-7">
                    <label class="form-label">Descricao</label>
                    <input type="text" class="form-input credito-extra-descricao" value="${item.descricao || ''}" placeholder="Descreva o credito">
                </div>
                <div class="md:col-span-3">
                    <label class="form-label">Valor</label>
                    <input type="text" class="form-input credito-extra-valor" value="${item.valor || ''}" placeholder="0,00">
                </div>
                <div class="md:col-span-2 flex md:justify-end">
                    <button type="button" class="btn-secondary remover-credito-extra w-full md:w-auto"><i class="fas fa-trash-alt mr-2"></i>Remover</button>
                </div>
            </div>
        `);
        creditosExtrasContainer.innerHTML = rows.join('');
        creditosExtrasContainer.querySelectorAll('.credito-extra-descricao').forEach(input => {
            input.addEventListener('input', event => {
                const wrapper = event.target.closest('[data-credito-extra-id]');
                const id = wrapper ? wrapper.dataset.creditoExtraId : null;
                const registro = state.creditosExtras.find(item => item.id === id);
                if(registro){
                    registro.descricao = event.target.value;
                }
            });
        });
        creditosExtrasContainer.querySelectorAll('.credito-extra-valor').forEach(input => {
            input.addEventListener('input', event => {
                const wrapper = event.target.closest('[data-credito-extra-id]');
                const id = wrapper ? wrapper.dataset.creditoExtraId : null;
                const registro = state.creditosExtras.find(item => item.id === id);
                if(registro){
                    registro.valor = event.target.value;
                    atualizarTotais();
                }
            });
        });
        creditosExtrasContainer.querySelectorAll('.remover-credito-extra').forEach(button => {
            button.addEventListener('click', event => {
                const wrapper = event.target.closest('[data-credito-extra-id]');
                const id = wrapper ? wrapper.dataset.creditoExtraId : null;
                state.creditosExtras = state.creditosExtras.filter(item => item.id !== id);
                renderCreditosExtras();
                atualizarTotais();
            });
        });
    }

    function renderDespesas(){
        if(!despesasContainer){ return; }
        if(!state.despesas.length){
            despesasContainer.innerHTML = '<p class="text-sm text-gray-500">Nenhuma despesa extra adicionada.</p>';
            return;
        }
        const rows = state.despesas.map(item => `
            <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end border border-gray-200 rounded p-3" data-despesa-id="${item.id}">
                <div class="md:col-span-7">
                    <label class="form-label">DescriÃ§Ã£o</label>
                    <input type="text" class="form-input despesa-descricao" value="${item.descricao || ''}" placeholder="Descreva a despesa">
                </div>
                <div class="md:col-span-3">
                    <label class="form-label">Valor</label>
                    <input type="text" class="form-input despesa-valor" value="${item.valor || ''}" placeholder="0,00">
                </div>
                <div class="md:col-span-2 flex md:justify-end">
                    <button type="button" class="btn-secondary remover-despesa w-full md:w-auto"><i class="fas fa-trash-alt mr-2"></i>Remover</button>
                </div>
            </div>
        `);
        despesasContainer.innerHTML = rows.join('');
        despesasContainer.querySelectorAll('.despesa-descricao').forEach(input => {
            input.addEventListener('input', event => {
                const wrapper = event.target.closest('[data-despesa-id]');
                const id = wrapper ? wrapper.dataset.despesaId : null;
                const despesa = state.despesas.find(d => d.id === id);
                if(despesa){
                    despesa.descricao = event.target.value;
                }
            });
        });
        despesasContainer.querySelectorAll('.despesa-valor').forEach(input => {
            input.addEventListener('input', event => {
                const wrapper = event.target.closest('[data-despesa-id]');
                const id = wrapper ? wrapper.dataset.despesaId : null;
                const despesa = state.despesas.find(d => d.id === id);
                if(despesa){
                    despesa.valor = event.target.value;
                    atualizarTotais();
                }
            });
        });
        despesasContainer.querySelectorAll('.remover-despesa').forEach(button => {
            button.addEventListener('click', event => {
                const wrapper = event.target.closest('[data-despesa-id]');
                const id = wrapper ? wrapper.dataset.despesaId : null;
                state.despesas = state.despesas.filter(d => d.id !== id);
                renderDespesas();
                atualizarTotais();
            });
        });
    }

    function atualizarTotais(){
        const totalCreditosBase = state.creditos.reduce((acc, item) => acc + parseValor(item.valor), 0);
        const totalCreditosExtras = state.creditosExtras.reduce((acc, item) => acc + parseValor(item.valor), 0);
        const totalCreditos = totalCreditosBase + totalCreditosExtras;
        const totalDebitos = state.debitos
            .filter(item => state.selectedDebitos.has(item.id))
            .reduce((acc, item) => acc + parseValor(item.valor_pendente), 0);
        const totalDespesas = state.despesas.reduce((acc, item) => acc + parseValor(item.valor), 0);
        const saldo = totalCreditos - totalDebitos - totalDespesas;

        totalCreditosEl.textContent = formatCurrency(totalCreditos);
        if(totalCreditosExtrasEl){
            totalCreditosExtrasEl.textContent = formatCurrency(totalCreditosExtras);
        }
        totalDebitosEl.textContent = formatCurrency(totalDebitos);
        totalDespesasEl.textContent = formatCurrency(totalDespesas);
        saldoFinalEl.textContent = formatCurrency(saldo);

        saldoFinalEl.classList.remove('text-green-600', 'text-red-600', 'text-gray-800');
        saldoFeedbackEl.classList.remove('text-green-600', 'text-red-600');
        saldoFeedbackEl.textContent = '';

        if(saldo > 0){
            saldoFinalEl.classList.add('text-green-600');
            saldoFeedbackEl.classList.add('text-green-600');
            saldoFeedbackEl.textContent = 'Saldo positivo: ap?s a aprova??o ser? gerado um t?tulo em contas a pagar para devolver ao cliente.';
        }else if(saldo < 0){
            saldoFinalEl.classList.add('text-red-600');
            saldoFeedbackEl.classList.add('text-red-600');
            saldoFeedbackEl.textContent = 'Saldo negativo: ap?s a aprova??o ser? criado um t?tulo em contas a receber para cobrar o cliente.';
        }else{
            saldoFinalEl.classList.add('text-gray-800');
            saldoFeedbackEl.textContent = 'Saldo zerado: ap?s a aprova??o n?o ser?o gerados novos t?tulos.';
        }
    }

    function carregarDados(dataStr){
        if(!previewUrl){ return; }
        feedbackEl.classList.remove('hidden');
        feedbackEl.textContent = 'Carregando informaÃ§Ãµes...';
        fetch(`${previewUrl}?data_encerramento=${dataStr}`)
            .then(resp => {
                if(!resp.ok){ throw new Error('Erro ao carregar dados'); }
                return resp.json();
            })
            .then(data => {
                state.creditos = data.creditos || [];
                state.debitos = (data.debitos || []).map(item => ({
                    ...item,
                    id: parseInt(item.id, 10),
                    valor: item.valor_previsto,
                    valor_pendente: item.valor_pendente
                }));
                renderCreditos();
                renderDebitos();
                renderCreditosExtras();
                renderDespesas();
                atualizarTotais();
                feedbackEl.textContent = `Dados carregados para ${dataStr.split('-').reverse().join('/')}`;
            })
            .catch(error => {
                console.error(error);
                creditosContainer.innerHTML = '<p class="text-sm text-red-600">NÃ£o foi possÃ­vel carregar os crÃ©ditos.</p>';
                debitosContainer.innerHTML = '<p class="text-sm text-red-600">NÃ£o foi possÃ­vel carregar os dÃ©bitos.</p>';
                feedbackEl.textContent = 'Erro ao carregar dados da prestaÃ§Ã£o de contas.';
            });
    }

    renderCreditosExtras();
    if(addCreditoExtraBtn){
        addCreditoExtraBtn.addEventListener('click', () => {
            const nextIndex = state.creditosExtras.length + 1;
            state.creditosExtras.push({ id: `credito-extra-${Date.now()}-${nextIndex}`, descricao: '', valor: '' });
            renderCreditosExtras();
            atualizarTotais();
        });
    }
    if(addDespesaBtn){
        addDespesaBtn.addEventListener('click', () => {
            const nextIndex = state.despesas.length + 1;
            state.despesas.push({ id: `despesa-${Date.now()}-${nextIndex}`, descricao: '', valor: '' });
            renderDespesas();
        });
    }

    if(dataInput){
        dataInput.addEventListener('change', () => {
            if(dataInput.value){
                carregarDados(dataInput.value);
            }
        });
    }

    const form = document.getElementById('prestacao-form');
    if(form){
        form.addEventListener('submit', event => {
            if(!dataInput.value){
                event.preventDefault();
                alert('Informe a data de encerramento.');
                dataInput.focus();
                return;
            }
            const creditosExtrasValidos = state.creditosExtras
                .map(item => ({ descricao: item.descricao.trim(), valor: item.valor }))
                .filter(item => item.descricao && parseValor(item.valor) > 0)
                .map(item => ({ descricao: item.descricao, valor: item.valor }));
            const despesasValidas = state.despesas
                .map(item => ({ descricao: item.descricao.trim(), valor: item.valor }))
                .filter(item => item.descricao && parseValor(item.valor) > 0)
                .map(item => ({ descricao: item.descricao, valor: item.valor }));

            const payload = {
                debitos_incluir: Array.from(state.selectedDebitos),
                debitos_desconsiderar: Array.from(state.cancelledDebitos),
                despesas: despesasValidas,
                creditos_extras: creditosExtrasValidos,
                observacoes: observacoesTextarea ? observacoesTextarea.value.trim() : ''
            };
            payloadInput.value = JSON.stringify(payload);
        });
    }

    if(initialDate){
        carregarDados(initialDate);
    }
})();
</script>
{% endblock %}



