<!-- templates/relatorios/contas_a_receber/index.html -->
{% extends "base.html" %}

{% block title %}Relatórios - Contas a Receber{% endblock %}
{% block page_title %}Relatórios de Contas a Receber{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <button type="button" class="card p-6 text-center flex flex-col items-center justify-center" onclick="openRelatorioCrModal()">
        <div class="text-icon-blue mb-4"><i class="fas fa-file-invoice-dollar fa-3x"></i></div>
        <h2 class="text-xl font-semibold text-dark-blue mb-2">Contas a Receber Detalhado</h2>
        <p class="text-medium-gray">Filtra por cliente, imóvel e vencimento.</p>
    </button>
    <button type="button" class="card p-6 text-center flex flex-col items-center justify-center" onclick="openRecebInqModal()">
        <div class="text-icon-blue mb-4"><i class="fas fa-file-alt fa-3x"></i></div>
        <h2 class="text-xl font-semibold text-dark-blue mb-2">Recebimento Por Inquilino</h2>
        <p class="text-medium-gray">Filtra por data de recebimento.</p>
    </button>
    <!-- Espaço para futuros relatórios -->
    <div></div>
    </div>

  <div id="rel-cr-modal" class="modal">
    <div class="modal-content max-w-3xl">
      <span class="close-button" onclick="closeRelatorioCrModal()">&times;</span>
      <h2 class="text-lg font-semibold mb-4">Contas a Receber Detalhado</h2>
      <form action="{{ url_for('relatorio_contas_a_receber_detalhado') }}" method="POST" target="_blank">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div class="form-group">
            <label for="rel-cr-cliente" class="form-label">Cliente:</label>
            <select id="rel-cr-cliente" name="cliente_id" class="form-select">
              <option value="">Todos os clientes</option>
              {% for cliente in clientes %}
                <option value="{{ cliente.id }}">{{ cliente.razao_social_nome }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="rel-cr-imovel" class="form-label">Imóvel:</label>
            <select id="rel-cr-imovel" name="imovel_id" class="form-select">
              <option value="">Todos os imóveis</option>
              {% for imovel in imoveis %}
                <option value="{{ imovel.id }}">
                  {{ imovel.tipo_imovel }} - {{ imovel.endereco }}{% if imovel.cidade or imovel.estado %}
                    ({{ imovel.cidade }}{% if imovel.estado %}/{{ imovel.estado }}{% endif %})
                  {% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="rel-cr-inicio" class="form-label">Vencimento Início:</label>
            <input type="date" id="rel-cr-inicio" name="vencimento_inicio" class="form-input" required>
          </div>
          <div class="form-group">
            <label for="rel-cr-fim" class="form-label">Vencimento Fim:</label>
            <input type="date" id="rel-cr-fim" name="vencimento_fim" class="form-input" required>
          </div>
        </div>
        <p class="text-xs text-gray-500 mb-4">Ao selecionar um cliente, apenas imóveis vinculados a ele serão exibidos (e vice-versa).</p>
        <div class="flex justify-end space-x-4">
          <button type="button" class="btn-secondary" onclick="closeRelatorioCrModal()">Cancelar</button>
          <button type="submit" class="btn-primary">Gerar Relatório</button>
        </div>
      </form>
    </div>
  </div>

  <div id="receb-inq-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeRecebInqModal()">&times;</span>
      <h2 class="text-lg font-semibold mb-4">Recebimento Por Inquilino</h2>
      <form action="{{ url_for('relatorio_recebimento_por_inquilino') }}" method="POST" target="_blank">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div class="form-group">
            <label for="data_inicio" class="form-label">Data Recebimento Início:</label>
            <input type="date" id="data_inicio" name="data_inicio" class="form-input" required>
          </div>
          <div class="form-group">
            <label for="data_fim" class="form-label">Data Recebimento Fim:</label>
            <input type="date" id="data_fim" name="data_fim" class="form-input" required>
          </div>
          <div class="form-group md:col-span-2">
            <label for="receitas_ids" class="form-label">Receitas (opcional):</label>
            <select id="receitas_ids" name="receitas_ids" multiple size="8" class="form-select">
              {% for r in receitas %}
                <option value="{{ r.id }}">{{ r.descricao }}</option>
              {% endfor %}
            </select>
            <p class="text-xs text-gray-500 mt-1">Segure Ctrl (Windows) ou Cmd (Mac) para selecionar múltiplas.</p>
          </div>
        </div>
        <div class="flex justify-end space-x-4">
          <button type="button" class="btn-secondary" onclick="closeRecebInqModal()">Cancelar</button>
          <button type="submit" class="btn-primary">Gerar PDF</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
function openRecebInqModal(){
  document.getElementById('receb-inq-modal').style.display='flex';
}
function closeRecebInqModal(){
  document.getElementById('receb-inq-modal').style.display='none';
}

function openRelatorioCrModal(){
  document.getElementById('rel-cr-modal').style.display='flex';
}
function closeRelatorioCrModal(){
  document.getElementById('rel-cr-modal').style.display='none';
}

document.addEventListener('DOMContentLoaded', () => {
  const vinculos = {{ vinculos_json|safe }};
  const clienteSelect = document.getElementById('rel-cr-cliente');
  const imovelSelect = document.getElementById('rel-cr-imovel');

  if (!clienteSelect || !imovelSelect) {
    return;
  }

  const clienteOptions = Array.from(clienteSelect.options).map((opt) => ({
    value: opt.value,
    text: opt.text,
  }));
  const imovelOptions = Array.from(imovelSelect.options).map((opt) => ({
    value: opt.value,
    text: opt.text,
  }));

  const mapaClienteImoveis = {};
  const mapaImovelClientes = {};

  vinculos.forEach((v) => {
    const clienteId = String(v.cliente_id);
    const imovelId = String(v.imovel_id);
    if (!mapaClienteImoveis[clienteId]) {
      mapaClienteImoveis[clienteId] = new Set();
    }
    if (!mapaImovelClientes[imovelId]) {
      mapaImovelClientes[imovelId] = new Set();
    }
    mapaClienteImoveis[clienteId].add(imovelId);
    mapaImovelClientes[imovelId].add(clienteId);
  });

  function reconstruirOpcoes(select, opcoesOriginais, permitidos){
    const valorAtual = select.value;
    select.innerHTML = '';
    opcoesOriginais.forEach((opt) => {
      const valor = opt.value;
      if (!permitidos || valor === '' || (permitidos.has && permitidos.has(valor))){
        const optionEl = document.createElement('option');
        optionEl.value = valor;
        optionEl.textContent = opt.text;
        if (valor === valorAtual){
          optionEl.selected = true;
        }
        select.appendChild(optionEl);
      }
    });
    if (select.value !== valorAtual){
      select.value = '';
    }
  }

  function atualizarImoveis(){
    const clienteId = clienteSelect.value;
    const valorAnterior = imovelSelect.value;
    const permitidos = clienteId ? (mapaClienteImoveis[clienteId] || new Set()) : null;
    reconstruirOpcoes(imovelSelect, imovelOptions, permitidos);
    if (imovelSelect.value !== valorAnterior){
      atualizarClientes();
    }
  }

  function atualizarClientes(){
    const imovelId = imovelSelect.value;
    const permitidos = imovelId ? (mapaImovelClientes[imovelId] || new Set()) : null;
    reconstruirOpcoes(clienteSelect, clienteOptions, permitidos);
  }

  clienteSelect.addEventListener('change', () => {
    atualizarImoveis();
  });

  imovelSelect.addEventListener('change', () => {
    atualizarClientes();
  });
});
</script>
{% endblock %}
