<!-- templates/relatorios/financeiro/index.html -->
{% extends "base.html" %}

{% block title %}Relatórios - Financeiro{% endblock %}
{% block page_title %}Relatórios Financeiros{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <button type="button" class="card p-6 text-center flex flex-col items-center justify-center" onclick="openContaModal()">
        <div class="text-icon-blue mb-4"><i class="fas fa-file-invoice-dollar fa-3x"></i></div>
        <h2 class="text-xl font-semibold text-dark-blue mb-2">Caixa/Banco</h2>
        <p class="text-medium-gray">Relatório de lançamentos por conta.</p>
    </button>
    <button type="button" class="card p-6 text-center flex flex-col items-center justify-center" onclick="openDespesaImovelModal()">
        <div class="text-icon-blue mb-4"><i class="fas fa-home fa-3x"></i></div>
        <h2 class="text-xl font-semibold text-dark-blue mb-2">Despesas Por Imóvel</h2>
        <p class="text-medium-gray">Relatório de despesas por imóvel.</p>
    </button>
    <button type="button" class="card p-6 text-center flex flex-col items-center justify-center" onclick="openFluxoCaixaModal()">
        <div class="text-icon-blue mb-4"><i class="fas fa-stream fa-3x"></i></div>
        <h2 class="text-xl font-semibold text-dark-blue mb-2">Fluxo de Caixa</h2>
        <p class="text-medium-gray">Entradas, saídas e saldo por período.</p>
    </button>
</div>

<div id="conta-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeContaModal()">&times;</span>
        <h2 class="text-lg font-semibold mb-4">Lançamentos por Conta</h2>
        <form action="{{ url_for('relatorio_financeiro_caixa_banco') }}" method="POST" target="_blank">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="form-group md:col-span-2">
                    <label for="tipo_conta" class="form-label">Tipo de Conta:</label>
                    <select id="tipo_conta" name="tipo_conta" class="form-select" onchange="filtrarContas()" required>
                        <option value="">Selecione</option>
                        <option value="caixa">Caixa</option>
                        <option value="banco">Banco</option>
                    </select>
                </div>
                <div class="form-group md:col-span-2">
                    <label for="conta_id" class="form-label">Conta:</label>
                    <select id="conta_id" name="conta_id" class="form-select" required>
                        <option value="">Selecione</option>
                        {% for c in caixas %}
                        <option value="{{ c.id }}" data-tipo="caixa">{{ c.nome }}</option>
                        {% endfor %}
                        {% for b in bancos %}
                        <option value="{{ b.id }}" data-tipo="banco">{{ b.nome_banco }} / {{ b.agencia }} / {{ b.conta }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="data_inicio" class="form-label">Data Início:</label>
                    <input type="date" id="data_inicio" name="data_inicio" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="data_fim" class="form-label">Data Fim:</label>
                    <input type="date" id="data_fim" name="data_fim" class="form-input" required>
                </div>
            </div>
            <div class="flex justify-end space-x-4">
                <button type="button" class="btn-secondary" onclick="closeContaModal()">Cancelar</button>
                <button type="submit" class="btn-primary">Gerar PDF</button>
            </div>
        </form>
    </div>
</div>
<div id="despesa-imovel-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeDespesaImovelModal()">&times;</span>
        <h2 class="text-lg font-semibold mb-4">Despesas Por Imóvel</h2>
        <form action="{{ url_for('relatorio_financeiro_despesas_imovel') }}" method="POST" target="_blank">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="form-group md:col-span-2">
                    <label for="imovel_id" class="form-label">Imóvel:</label>
                    <select id="imovel_id" name="imovel_id" class="form-select" required>
                        <option value="">Selecione</option>
                        {% for imovel in imoveis %}
                        <option value="{{ imovel.id }}">{{ imovel.tipo_imovel }} / {{ imovel.endereco }} / {{ imovel.cidade }}/{{ imovel.estado }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="data_inicio_imovel" class="form-label">Data Pagamento Início:</label>
                    <input type="date" id="data_inicio_imovel" name="data_inicio" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="data_fim_imovel" class="form-label">Data Pagamento Fim:</label>
                    <input type="date" id="data_fim_imovel" name="data_fim" class="form-input" required>
                </div>
                <div class="form-group md:col-span-2">
                    <label for="despesa_id" class="form-label">Despesas:</label>
                    <select id="despesa_id" name="despesa_id" class="form-select">
                        <option value="">Todas</option>
                        {% for despesa in despesas %}
                        <option value="{{ despesa.id }}">{{ despesa.descricao }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="flex justify-end space-x-4">
                <button type="button" class="btn-secondary" onclick="closeDespesaImovelModal()">Cancelar</button>
                <button type="submit" class="btn-primary">Gerar PDF</button>
            </div>
        </form>
    </div>
</div>
<div id="fluxo-caixa-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeFluxoCaixaModal()">&times;</span>
        <h2 class="text-lg font-semibold mb-4">Fluxo de Caixa</h2>
        <form action="{{ url_for('relatorio_financeiro_fluxo_caixa_visualizar') }}" method="POST">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="form-group">
                    <label for="fluxo_data_inicio" class="form-label">Data Início:</label>
                    <input type="date" id="fluxo_data_inicio" name="data_inicio" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="fluxo_data_fim" class="form-label">Data Fim:</label>
                    <input type="date" id="fluxo_data_fim" name="data_fim" class="form-input" required>
                </div>
                <div class="form-group md:col-span-2">
                    <label class="form-label">Contas de Caixa (múltipla seleção):</label>
                    <div class="relative">
                        <button type="button" class="form-input text-left pr-8" onclick="toggleCombo('caixas')">
                            <span id="combo-label-caixas">Selecione...</span>
                            <i class="fas fa-chevron-down absolute right-3 top-3 text-gray-500"></i>
                        </button>
                        <div id="combo-panel-caixas" class="absolute z-50 w-full bg-white border rounded mt-1 max-h-60 overflow-y-auto hidden">
                            <div class="p-2">
                                <input type="text" class="w-full border rounded p-1" placeholder="Filtrar..." oninput="filterCombo('caixas', this.value)">
                            </div>
                            {% for c in caixas %}
                            <label class="flex items-center px-3 py-2 hover:bg-gray-100 cursor-pointer">
                                <input type="checkbox" class="mr-2 combo-item-caixas" name="caixas_ids" value="{{ c.id }}" onchange="updateComboLabel('caixas')">
                                <span class="combo-text">{{ c.nome }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="form-group md:col-span-2">
                    <label class="form-label">Contas Bancárias (múltipla seleção):</label>
                    <div class="relative">
                        <button type="button" class="form-input text-left pr-8" onclick="toggleCombo('bancos')">
                            <span id="combo-label-bancos">Selecione...</span>
                            <i class="fas fa-chevron-down absolute right-3 top-3 text-gray-500"></i>
                        </button>
                        <div id="combo-panel-bancos" class="absolute z-50 w-full bg-white border rounded mt-1 max-h-60 overflow-y-auto hidden">
                            <div class="p-2">
                                <input type="text" class="w-full border rounded p-1" placeholder="Filtrar..." oninput="filterCombo('bancos', this.value)">
                            </div>
                            {% for b in bancos %}
                            <label class="flex items-center px-3 py-2 hover:bg-gray-100 cursor-pointer">
                                <input type="checkbox" class="mr-2 combo-item-bancos" name="bancos_ids" value="{{ b.id }}" onchange="updateComboLabel('bancos')">
                                <span class="combo-text">{{ b.nome_banco }} / {{ b.agencia }} / {{ b.conta }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-4">
                <button type="button" class="btn-secondary" onclick="closeFluxoCaixaModal()">Cancelar</button>
                <button type="submit" class="btn-primary">Visualizar</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function openContaModal(){
    document.getElementById('conta-modal').style.display='flex';
}
function closeContaModal(){
    document.getElementById('conta-modal').style.display='none';
}
function filtrarContas(){
    const tipo = document.getElementById('tipo_conta').value;
    const contaSelect = document.getElementById('conta_id');
    Array.from(contaSelect.options).forEach(opt => {
        if(!opt.value) return;
        opt.style.display = opt.getAttribute('data-tipo') === tipo ? '' : 'none';
    });
    contaSelect.value = '';
}
function openDespesaImovelModal(){
    document.getElementById('despesa-imovel-modal').style.display='flex';
}
function closeDespesaImovelModal(){
    document.getElementById('despesa-imovel-modal').style.display='none';
}
function openFluxoCaixaModal(){
    document.getElementById('fluxo-caixa-modal').style.display='flex';
}
function closeFluxoCaixaModal(){
    document.getElementById('fluxo-caixa-modal').style.display='none';
}

// --- Combobox múltipla seleção com checkboxes ---
function toggleCombo(kind){
    const panel = document.getElementById(`combo-panel-${kind}`);
    panel.classList.toggle('hidden');
}

function updateComboLabel(kind){
    const label = document.getElementById(`combo-label-${kind}`);
    const items = document.querySelectorAll(`#combo-panel-${kind} input[type=checkbox]`);
    const selected = Array.from(items).filter(i => i.checked);
    if(selected.length === 0){
        label.textContent = 'Selecione...';
        return;
    }
    const names = selected.slice(0,3).map(i => i.closest('label').querySelector('.combo-text').textContent.trim());
    if(selected.length <= 3){
        label.textContent = names.join(', ');
    } else {
        label.textContent = `${names.join(', ')} +${selected.length-3}`;
    }
}

function filterCombo(kind, term){
    const t = (term || '').toLowerCase();
    const rows = document.querySelectorAll(`#combo-panel-${kind} label`);
    rows.forEach(r => {
        const txt = r.querySelector('.combo-text').textContent.toLowerCase();
        r.style.display = txt.includes(t) ? '' : 'none';
    });
}

// Fecha combos ao clicar fora
document.addEventListener('click', (e) => {
    ['caixas','bancos'].forEach(kind => {
        const panel = document.getElementById(`combo-panel-${kind}`);
        const btn = document.querySelector(`button[onclick="toggleCombo('${kind}')"]`);
        if(panel && !panel.classList.contains('hidden')){
            if(!panel.contains(e.target) && !btn.contains(e.target)){
                panel.classList.add('hidden');
            }
        }
    });
});
</script>
{% endblock %}
