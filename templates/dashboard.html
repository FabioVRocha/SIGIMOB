<!-- templates/dashboard.html -->
{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block page_title %}Visão Geral{% endblock %}

{% block content %}
<div id="dashboard-content" class="content-section">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="dashboard-card alert-card">
            <div class="dashboard-card-header">
                <i class="fas fa-exclamation-triangle"></i> Alertas
            </div>
            <p class="text-sm text-gray-700">
                <strong>Contas a Receber</strong><br>
                Quantidade de Títulos Atrasado: {{ qtd_titulos_atrasados }}<br>
                Valor Total de Títulos Atrasado: {{ valor_total_titulos_atrasados | currency }}<br>
                <br>
                <strong>Contas a Pagar</strong><br>
                Quantidade de Títulos Atrasado: {{ qtd_titulos_atrasados_pagar }}<br>
                Valor Total de Títulos Atrasado: {{ valor_total_titulos_atrasados_pagar | currency }}
            </p>
        </div>

        <div class="dashboard-card notice-card">
            <div class="dashboard-card-header">
                <i class="fas fa-info-circle"></i> Avisos
            </div>
            <ul class="text-sm text-gray-700 space-y-3">
                {% if avisos_contratos %}
                {% for aviso in avisos_contratos %}
                <li class="flex items-start">
                    <span class="w-2 h-2 rounded-full mr-2 mt-1 {{ 'bg-red-500' if aviso.dias_restantes is not none and aviso.dias_restantes <= 5 else 'bg-yellow-500' }}"></span>
                    <div>
                        <p class="font-semibold text-gray-800">Contrato #{{ aviso.id }}{% if aviso.nome_inquilino %} - {{ aviso.nome_inquilino }}{% endif %}</p>
                        <p class="text-gray-600">Termina em {{ aviso.data_fim }}{% if aviso.dias_restantes is not none %} ({{ aviso.dias_restantes }} dia{% if aviso.dias_restantes != 1 %}s{% endif %}){% endif %}</p>
                        {% if aviso.localizacao %}
                        <p class="text-xs text-gray-500">{{ aviso.localizacao }}</p>
                        {% endif %}
                    </div>
                </li>
                {% endfor %}
                {% else %}
                <li class="flex items-center text-gray-500">
                    <span class="w-2 h-2 bg-gray-400 rounded-full mr-2"></span>
                    Nenhum contrato com termino nos proximos 15 dias.
                </li>
                {% endif %}
            </ul>
        </div>

        <!-- Quadro substituto: Tarefas Pendentes -->
        <div class="dashboard-card tarefas-pendentes-card lg:row-span-2 md:row-span-2 h-full flex flex-col">
            <div class="dashboard-card-header">
                <i class="fas fa-tasks"></i> Tarefas Pendentes
            </div>
            <div class="text-sm text-gray-700 space-y-3 flex-1 overflow-y-auto">
                {% if prestacoes_pendentes %}
                <ul class="space-y-3">
                    {% for prestacao in prestacoes_pendentes %}
                    <li class="p-3 bg-gray-50 border border-gray-200 rounded-lg">
                        <div class="flex justify-between gap-3">
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">
                                    Contrato #{{ prestacao.contrato_id }}{% if prestacao.nome_inquilino %} - {{ prestacao.nome_inquilino }}{% endif %}
                                </p>
                                <p class="text-xs text-gray-600">
                                    Encerramento: {{ prestacao.data_encerramento.strftime('%d/%m/%Y') if prestacao.data_encerramento else 'Data não informada' }}
                                </p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-semibold text-dark-blue">{{ prestacao.saldo_final | currency }}</p>
                                <a href="{{ url_for('contratos_prestacoes_list', contrato_id=prestacao.contrato_id) }}" class="text-xs text-blue-600 hover:text-blue-800">Abrir</a>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-gray-600">Sem tarefas pendentes no momento.</p>
                {% endif %}
            </div>
        </div>

        <!-- Novo Card: Imóveis Ativos -->
        <div class="dashboard-card active-employees-card">
            <div class="dashboard-card-header">
                <i class="fas fa-home"></i> Imóveis Ativos
            </div>
            <p class="text-3xl font-bold text-dark-blue">{{ total_imoveis_ativos }}</p>
            <p class="text-sm text-gray-700">Total de imóveis ativos no sistema.</p>
        </div>

        <!-- Card: Percentual de Imóveis Alugados -->
        <div class="dashboard-card rented-percentage-card">
            <div class="dashboard-card-header">
                <i class="fas fa-percentage"></i> Imóveis Alugados
            </div>
            <p class="text-3xl font-bold text-dark-blue">{{ '{:.1f}'.format(percent_imoveis_alugados) }}%</p>
            <p class="text-sm text-gray-700">Proporção de imóveis com contrato ativo.</p>
        </div>

        <!-- Novo Card: Contratos Ativos (posicionado abaixo de Imóveis Alugados) -->
        <div class="dashboard-card active-contracts-card">
            <div class="dashboard-card-header">
                <i class="fas fa-file-contract"></i> Contratos Ativos
            </div>
            <p class="text-3xl font-bold text-dark-blue">{{ total_contratos_ativos }}</p>
            <p class="text-sm text-gray-700">Total de contratos de aluguel ativos.</p>
        </div>

        <div class="dashboard-card balance-card">
            <div class="dashboard-card-header">
                <i class="fas fa-wallet"></i> Financeiro
            </div>
            <p class="text-3xl font-bold text-dark-blue">{{ saldo_total | currency }}</p>
            <p class="text-sm text-gray-700">Conciliações pendentes: {{ conciliacoes_pendentes }}</p>
            {% if alertas_saldo_negativo > 0 %}
            <p class="text-sm text-red-600">Contas com saldo negativo: {{ alertas_saldo_negativo }}</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}{% endblock %}
